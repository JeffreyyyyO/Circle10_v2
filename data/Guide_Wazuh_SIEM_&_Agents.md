# **Wazuh SIEM & Agents**

# **Deploying Wazuh SIEM on AWS EC2 & Connecting Local VM Agents**

**Objective:** Deploy a Wazuh Server on the cloud (AWS EC2) and monitor local virtual machines (Linux & Windows) running in your VMware lab.  
**Architecture Overview:**

* **Wazuh Server:** Hosted on AWS EC2 (Public Internet).  
* **Wazuh Agents:** Hosted locally on VMware Workstation (Private Network).  
* **Networking:** Agents connect *outbound* to the AWS Server via your Sophos Firewall NAT.

## **Phase 1: AWS EC2 Deployment (Wazuh Server)**

We need a cloud server to act as the central manager. We will use Ubuntu Server for the base OS.  
**1\. Launch Instance**

1. Log in to your AWS Console and navigate to **EC2**.  
2. Click **Launch Instance**.  
3. **Name:** Wazuh-Server-Lab  
4. **OS Images:** Select **Ubuntu** (Ubuntu Server 22.04 LTS or 24.04 LTS).  
   ***Note:** Default username is set to “ubuntu” by default.*  
5. **Instance Type:** Select **t3.medium** (2 vCPU, 4 GiB Memory) or **t3.large** (2 vCPU, 8 GiB Memory). If you are on Free Tier, use **m7i.large** (2 vCPU, 8 GiB Memory).
   * **CRITICAL WARNING:** Do **NOT** use t2.micro (Free Tier). It has only 1GB RAM. The Wazuh database **will crash** immediately on startup.  
6. **Key Pair:** Create a new key pair (e.g., wazuh-key.pem) and download it.  
   * **Note:** Save this file to a known folder (e.g., C:\\Users\\Student\\Downloads). **Do not lose it.**  
7. **Network Settings:** Click "Edit" (or "Create Security Group") and set the following inbound rules:

| Type | Port Range | Source | Reason |
| :---- | :---- | :---- | :---- |
| **SSH** | 22 | My IP | Admin access to the server terminal. |
| **HTTPS** | 443 | My IP | Access to the Wazuh Web Dashboard. |
| **Custom TCP** | 1514 | Anywhere (0.0.0.0/0) | Agent event data communication. |
| **Custom TCP** | 1515 | Anywhere (0.0.0.0/0) | Agent enrollment service. |

* *Note:* `0.0.0.0/0` allows connections from anywhere. In a production environment, you would restrict this to your lab's public IP.  
8. **Storage:** Increase storage to **30 GiB** (Logs take up space).  
9. Click **Launch Instance**.

## **Phase 2: Installing Wazuh Manager**

We will use the automated "Quickstart" installation script.

1. **Connect to your EC2 Instance:**  
   * Open **PowerShell** on your Windows Host machine.  
   * Run the SSH command using the path to your key file and your AWS IP.  
   * **Syntax:** `ssh -i "path\to\keyfile.pem" ubuntu@IP_ADDRESS`

   Example: If your key is in Downloads and your AWS IP is **3.92.91.61**, type:  
     `ssh -i "C:\Users\Student\Downloads\wazuh-key.pem" ubuntu@3.92.91.61`

   * *Tip:* Do not type the \< or \> brackets.  
   * *Tip:* If asked "Are you sure you want to continue connecting?", type yes and hit Enter.

2. **Run the Installation Commands (Separately):**  
   **Command A (Download):**  
   Copy and paste this exactly:  
   `curl -sO https://packages.wazuh.com/4.11/wazuh-install.sh`  
   **Command B (Install):**  
   Copy and paste this exactly (the \-i flag ignores minor hardware check errors):  
   `sudo bash ./wazuh-install.sh -a -i`

3. **Wait & Save Credentials:**  
   * The installation takes about 5-10 minutes.  
   * **CRITICAL:** At the end, it will display a **User** (admin) and **Password**. Copy these to a notepad immediately.

## **Phase 3: Accessing the Dashboard**

1. On your **Windows 10 Host machine**, open a browser.  
2. Navigate to: `https://<YOUR_EC2_IP>` (e.g., `https://3.92.91.61`)  
3. **Security Warning:** You will see a "Connection is not private" warning.  
   * *Why?* Wazuh generated a self-signed certificate. Since we don't have a purchased domain name, this is expected.  
   * Click **Advanced** \-\> **Proceed to... (unsafe)**.  
4. Login using the credentials saved in Phase 2\.

## **Phase 4: Connecting the Linux Endpoint (Ubuntu VM)**

We will now install the agent on your local Ubuntu VM and point it to the cloud server.

1. **Prepare the VM:**  
   * **Power on** your **Ubuntu VM** in VMware.  
   * **Open a terminal** inside the VM.  
   * **Verify internet access:** run the command `ping -c 3 google.com` (If this fails, check your Sophos Firewall rules).

2. **Set up the Installation Command:**  
   * In the **Wazuh Dashboard** (from your host), click **"Add agent"**.  
   * **OS:** Linux \-\> Debian/Ubuntu \-\> amd64.  
   * **Wazuh server address:** Enter your **EC2 Public IP** (eg., **3.92.91.61**).  
   * **Agent name:** Ubuntu-Lab-Agent

3. **Collect the Agent Installation Command:**  
   Copy the command generated by the dashboard. It will look similar to this:  
   `wget https://packages.wazuh.com/4.x/apt/pool/main/w/wazuh-agent/wazuh-agent_4.11.0-1_amd64.deb && sudo WAZUH_MANAGER='<YOUR_EC2_IP>' WAZUH_AGENT_GROUP='default' dpkg -i ./wazuh-agent_4.11.0-1_amd64.deb`  
   **Note:** Replace `<YOUR_EC2_IP>` with the instance IP address, excluding the angle brackets.

4. **Run the Installation Command:**  
   Paste the generated command in the Ubuntu terminal and run it.

5. **Start the Agent:**  
   Run the following commands in sequence (one after the other). This starts the Wazuh Agent.  
   `sudo systemctl daemon-reload`  
   `sudo systemctl enable wazuh-agent`  
   `sudo systemctl start wazuh-agent`

## **Phase 5: Connecting the Windows Endpoint (Server 2022\)**

1. **Prepare the VM:**  
   * Power on your **Windows Server 2022 VM**.  
   * Log in and open **PowerShell** as Administrator.

2. **Set up the Installation Command:**  
   * In the **Wazuh Dashboard** (from your host), click **"Add agent"**.  
   * **OS:** Windows \-\> MSI 64 bits.  
   * **Wazuh server address:** Enter your **EC2 Public IP** (eg., **3.92.91.61**).  
   * **Agent name:** WinServer22-Lab

3. **Collect the Agent Installation Command:**  
   Copy the PowerShell command generated by the dashboard. It will look similar to this:  
   `Invoke-WebRequest -Uri https://packages.wazuh.com/4.x/windows/wazuh-agent-4.11.0-1.msi -OutFile ${env:tmp}\wazuh-agent.msi; msiexec.exe /i ${env:tmp}\wazuh-agent.msi /q WAZUH_MANAGER='<YOUR_EC2_IP>' WAZUH_AGENT_GROUP='default' WAZUH_AGENT_NAME='WinServer22-Lab'`  
   **Note:** Replace `<YOUR_EC2_IP>` with the instance IP address, excluding the angle brackets.

4. **Run the Installation Command:**  
   Paste the generated command in the Powershell terminal and run it.

5. **Start the Agent:**  
   Run the following command to start the Wazuh Agent.  
   `Start-Service -Name WazuhSvc`

## **Phase 6: Verification & Firewall Note**

1. **Check Connection:**  
   * Go back to your **Wazuh Dashboard** on the Host machine.  
   * Click on the **Wazuh** logo (top left) to refresh.  
   * You should see **Total agents: 2** and **Active agents: 2**.

2. **Note on Sophos Firewall:**  
   * The agents communicate on TCP ports **1514** and **1515**.  
   * Since your VMs are behind a NAT, the Sophos firewall generally allows outbound traffic by default.  
   * **If agents never appear:** Check the Sophos Firewall "Log Viewer". If you see "Deny" for traffic going to your AWS IP on port 1514, you must create a Firewall Rule allowing:  
     * **Source Zone:** LAN (or DMZ, wherever VMs are).  
     * **Dest Zone:** WAN.  
     * **Services:** Custom (TCP 1514, 1515).

## **Phase 7: Resuming the Lab (After Shutdown)**

In a lab environment, you will likely stop your AWS instance to save costs. **When you start it again, the Public IP Address will change.** This breaks the connection to your agents.  
Follow these steps every time you restart your lab.

### **1\. Start the AWS Instance**

1. Log in to the **AWS Console** and navigate to **EC2**.  
2. Select your Wazuh-Server-Lab instance.  
3. Click **Instance State** \> **Start instance**.  
4. Wait for the **Instance state** to change to Running.  
5. Copy the **New Public IPv4 Address** from the instance description.

### **2\. Start Wazuh Services (Recommended)**

Sometimes the Wazuh application services do not start automatically or get stuck. It is best to manually start them to ensure the dashboard is accessible.

1. Open **PowerShell** on your Host machine and SSH into the server using the **New IP**:  
   `ssh -i "C:\path\to\wazuh-key.pem" ubuntu@NEW_IP_ADDRESS`  
   ***Note:** Replace* `NEW_IP_ADDRESS` *with the new computing instance IP address.*

2. Run the following commands in sequence (one after the other) to ensure all services are up. This starts the Wazuh Server.  
   `sudo systemctl start wazuh-indexer`  
   `sudo systemctl start wazuh-manager`  
   `sudo systemctl start wazuh-dashboard`  
   ***Note:** If they are already running, this command will simply ensure they stay running.*

### **3\. Update the Linux Agent (Ubuntu)**

1. **Open a terminal** on your Ubuntu VM.  
2. **Edit the configuration** file (ossec.conf):  
   `sudo nano /var/ossec/etc/ossec.conf`

3. **Change the IP**   
   * Use the arrow keys to find the \<client\> section.  
   * Change the IP address (inside the \<address\> tags) to your **New AWS IP** (this is the new AWS EC2 computing instance IP address).  
     `<client>`  
       `<server>`  
         `<address>NEW.AWS.IP.HERE</address>`

4. **Save and Exit:** Press Ctrl+O, Press Enter, then Press Ctrl+X.  
5. **Restart the agent** to apply changes:  
   `sudo systemctl restart wazuh-agent`

### **4\. Update the Windows Agent (Server 2022\)**

1. **Log in** to your Windows VM.  
2. Open **Notepad** as **Administrator** (Right-click \-\> Run as Administrator).  
3. File \-\> Open \-\> Navigate to: C:\\Program Files (x86)\\ossec-agent\\ossec.conf.  
   * *Note: You may need to change the file type dropdown from "Text Documents" to "All Files" to see it.*  
4. Find the \<address\> tag and update it with the **New AWS IP**.  
5. Save the file.  
6. Open **PowerShell** as Administrator and restart the service using the following command:  
   `Restart-Service -Name WazuhSvc`

### **5\. Verify Connection**

Refresh your Wazuh Dashboard (using the new IP URL). The agents should show as **Active** within 30-60 seconds.

# **Maintaining a Consistent Public IP**

How to maintain a Public IP after stopping and starting the EC2 machine instance

In order to ensure that the AWS EC2 instance (which hosts the Wazuh Server) maintains the same public IP, you would need to create an Elastic IP address (EIP) and associate it with the computing instance. Here’s a step-by-step guide on how to achieve that:

1. ## **Allocate a New Elastic IP:**

   * Open the Amazon EC2 console.  
   * In the navigation pane, under **Network & Security**, select **Elastic IPs**.  
   * Choose **Allocate Elastic IP address**.  
   * Select **Amazon's pool of IPv4 addresses** and click **Allocate**.

2. ## **Associate the Elastic IP with Your Instance:**

   * Select the newly allocated Elastic IP address from the list.  
   * Choose **Actions** \> **Associate Elastic IP address**.  
   * For **Resource type**, select **Instance**.  
   * In the **Instance** field, select your target EC2 instance (the one running the Wazuh server) from the drop-down list.  
   * The private IP field should auto-fill. If it doesn’t, click the drop-down menu and select the IP option (which is the existing Private IP).  
   * Click **Associate**.

### **Key Considerations**

**Cost:** You are not charged for an Elastic IP address as long as it is associated with a running instance. You are, however, charged if the Elastic IP is allocated to your account but not associated with an instance (or associated with a stopped instance).  
**Persistence:** Once associated, the Elastic IP remains tied to your instance even if you stop and restart the instance (unlike the dynamic public IP).

# **Snapshots: Using Snapshots with Computing Instances**

## **Step 1: Create a Snapshot**

1\. Go to the AWS Management Console.  
2\. Navigate to the EC2 dashboard.  
3\. Select the instance you want to snapshot.  
4\. Right-click on the instance and select Instance settings \> Create snapshot.  
5\. Choose the root volume (or select multiple volumes if needed).  
6\. Add a description and click Create snapshot.

## **Step 2: Restore the Instance from Snapshot**

To restore the instance from the snapshot, follow these steps:

1\. Go to the AWS Management Console.  
2\. Navigate to the EC2 dashboard.  
3\. Click on Snapshots in the sidebar.  
4\. Select the snapshot you created earlier.  
5\. Click Actions \> Create image from snapshot.  
6\. Fill in the required details (e.g., name, description).  
7\. Click Create image.

## **Step 3: Launch a New Instance from the Image**

1\. Go to the EC2 dashboard.  
2\. Click on Images \> AMIs in the sidebar.  
3\. Select the image you created earlier.  
4\. Click Launch instance from AMI.  
5\. Choose the instance type and configure other settings as needed.  
6\. In the Configure Instance Details section:  
    \- Select the same VPC and subnet as the original instance.  
    \- Ensure the Auto-assign Public IP option is set to Disable.  
7\. Click Next: Add Storage and configure storage settings as needed.  
8\. Click Next: Add Tags and add tags as needed.  
9\. Click Next: Configure Security Group and select the same security group as the original instance.  
10\. Click Review and Launch and then Launch.

## **Step 4: Associate the Elastic IP**

1\. Go to the VPC dashboard.  
2\. Click on Elastic IPs in the sidebar.  
3\. Select the EIP you allocated earlier.  
4\. Click Actions \> Associate Elastic IP address.  
5\. Select the new instance and click Associate.

Your new instance should now have the same public IP address as the original instance. Verify the IP address and ensure everything is working as expected.

By following these steps, you'll be able to create a snapshot of your EC2 instance and restore it later with the same public IP address.
