<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circle10 Study App</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Marked.js Library (for rendering Markdown) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Google Fonts: Inter & Sora & Space Grotesk -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&family=Sora:wght@300;400;600;900&family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Force body and html to 100% width and prevent horizontal scroll */
        html, body {
            width: 100%;
            overflow-x: hidden;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #333333; /* Plain dark gray background color */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Ensure it takes full viewport height */
            margin: 0;
            padding: 0; /* Removed body padding */
            box-sizing: border-box; 
        }
        
        /* Container is now a flex-col layout for the main content and nav bar */
        .quiz-container {
            width: 100%;       
            min-height: 100vh;  /* Fill the viewport height */
            max-width: 500px;   /* A good upper limit for a "phone" app UI */
            
            background-color: #d0d0d0;
            border-radius: 0; 
            
            /* Container is now a flex column with 0 padding */
            display: flex;
            flex-direction: column;
            padding: 0; /* Padding is now on the screens and nav bar */
            
            transition: all 0.3s ease-in-out;
            box-sizing: border-box;
            overflow: hidden; /* Hide overflow */
        }
        
        /* This area holds all the screens */
        #main-content-area {
            flex-grow: 1; /* Takes up all available space above the nav bar */
            position: relative; /* For the absolute positioned screens */
            overflow: hidden; /* For the transition */
        }

        /* Screens are now inside the main-content-area */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 5vw 2vw 0 2vw; 
            box-sizing: border-box;
            background-color: #d0d0d0; /* Match container color */
            transition: transform 0.3s ease-out, background-color 0.3s ease;
            z-index: 10;
            
            /* Ensure screens are flex-col to fill height */
            display: flex;
            flex-direction: column;
        }

        /* Horizontal padding override for lobby/format/notes/decks/misc screens */
        #lobby-screen, 
        #notes-screen,
        #decks-screen,
        #misc-screen,
        #tests-screen, 
        #format-screen {
            padding-left: 0;
            padding-right: 0;
        }

        /* Reader Screen padding override */
        #reader-screen {
            padding-top: 0;
            padding-left: 0;
            padding-right: 0;
        }

        /* Screen transition states */
        .screen.current {
            transform: translateX(0);
        }
        .screen.left {
            transform: translateX(-100%);
        }
        .screen.right {
            transform: translateX(100%);
        }
        
        #quiz-main-content {
            flex-grow: 1; /* Pushes buttons to the bottom */
            overflow-y: auto; /* Allows questions/options to scroll if needed */
        }
        
        .option-button {
            display: block;
            width: 100%;
            padding: 15px 20px;
            margin-bottom: 10px;
            background-color: #e2e8f0; /* Light gray */
            color: #334155; /* Dark gray text */
            border: 2px solid #cbd5e1; /* Lighter border */
            border-radius: 12px;
            text-align: left;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            box-sizing: border-box;
            font-family: 'Sora', sans-serif; /* Sora font for options */
            font-weight: 400;
        }
        .option-button:hover {
            background-color: #d1d9e2;
            border-color: #94a3b8;
        }
        .option-button.selected {
            background-color: #a7d9f8; /* Light blue for selected */
            border-color: #38bdf8; /* Blue border for selected */
            color: #0c4a6e; /* Darker blue text */
        }
        .option-button.correct {
            background-color: #d1fae5; /* Light green for correct */
            border-color: #34d399; /* Green border for correct */
            color: #065f46; /* Dark green text */
        }
        .option-button.incorrect {
            background-color: #fee2e2; /* Light red for incorrect */
            border-color: #ef4444; /* Red border for incorrect */
            color: #991b1b; /* Dark red text */
        }
        
        /* --- Font Application --- */
        #question-text {
            font-family: 'Sora', sans-serif;
            font-weight: 600;
        }
        
        #lobby-screen h1,
        #notes-screen h1,
        #decks-screen h1,
        #misc-screen h1,
        #tests-screen h1,
        #format-screen h1,
        #reader-title,
        #results-screen h2,
        #performance-screen h2,
        #message-title {
            font-family: 'Sora', sans-serif;
        }
        
        /* Anchor Link Styles */
        #reader-anchor-overlay h3, 
        .anchor-link-item {
            font-family: 'Sora', sans-serif;
        }

        .score-indigo-text {
            color: #4f46e5; 
        }
        
        .submit-button {
            background-color: #3b82f6; /* Blue */
            color: white;
            padding: 14px 25px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 300; /* Adjusted font weight */
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
        }
        .submit-button:hover {
            background-color: #2563eb; /* Darker blue on hover */
        }
        .submit-button:disabled {
            background-color: #93c5fd; /* Lighter blue when disabled */
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .quit-button {
            background-color: #ef4444; /* Red */
            color: white;
            padding: 14px 25px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 300; /* Adjusted font weight */
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
        }
        .quit-button:hover {
            background-color: #dc2626; /* Darker red on hover */
        }
        
        .lobby-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 20px;
            margin-top: 20px;
            overflow-y: auto; /* Allow scrolling if cards overflow */
            flex-grow: 1; /* Make it fill the space */
            
            /* --- SCROLLBAR HIDING --- */
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
            
            padding-left: 2vw;
            padding-right: 2vw;
            box-sizing: border-box;

            padding-bottom: 5vw;
        }
        .lobby-buttons::-webkit-scrollbar {
            display: none; /* Chrome, Safari */
        }
        
        /* --- Base Card Style --- */
        .quiz-card-base {
            aspect-ratio: 1 / 1; 
            border-radius: 16px;
            font-weight: 300;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            text-align: center;
            width: 100%;
        }

        /* --- Indigo Card Color --- */
        .quiz-card-indigo {
            background-color: #4f46e5; /* Indigo/Purple */
            color: white;
        }
        .quiz-card-indigo:hover {
            background-color: #4338ca; /* Darker indigo on hover */
        }

        /* --- Orange Card Color --- */
        .quiz-card-orange {
            background-color: #CC5500; /* Burnt Orange */
            color: white;
        }
        .quiz-card-orange:hover {
            background-color: #aa4400; /* Darker Orange */
        }
        
        /* --- Lobby Card Color --- */
        /* UPDATED: Changed from Brown to Teal #004545 */
        .quiz-card-lobby {
            background-color: #004545; /* Teal */
            color: white;
        }
        .quiz-card-lobby:hover {
            background-color: #003333; /* Darker Teal on hover */
        }

        /* --- Dark Green Card Color --- */
        .quiz-card-darkgreen {
            background-color: #013220; /* Dark Green */
            color: white;
        }
        .quiz-card-darkgreen:hover {
            background-color: #024b30; /* Slightly lighter Green on hover */
        }
        
        .format-card-button {
            aspect-ratio: 1 / 1; 
            background-color: #800000; /* Maroon color */
            color: white;
            border-radius: 16px;
            font-weight: 300;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            text-align: center;
            width: 100%;
        }
        .format-card-button:hover {
            background-color: #660000; /* Darker maroon on hover */
        }
        
        /* Surfing Card Specific Styles */
        .surfing-card {
            background-color: #7bace0;
            color: #0d2036;
            grid-column: 1 / span 2; /* Span across 2 columns */
            aspect-ratio: 2 / 0.5; /* Match width of 2 cards, half height of 1 */
            padding: 10px;
        }
        .surfing-card:hover {
            background-color: #6a95c0; /* Darker blue for hover */
        }


        .card-subtitle {
            font-size: 0.875rem; /* text-sm */
            opacity: 0.8;
            font-weight: 400;
        }
        .card-title {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600;
            margin-bottom: 4px; /* Added bottom margin */
            line-height: 1; /* Added line-height */
        }
        .performance-item {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: left;
        }
        .performance-question {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
        }
        .performance-answer {
            margin-bottom: 5px;
            color: #475569;
        }
        .performance-answer.correct-feedback {
            color: #065f46; /* Dark green */
            font-weight: 500;
        }
        .performance-answer.incorrect-feedback {
            color: #991b1b; /* Dark red */
            font-weight: 500;
        }
        .performance-correct-answer {
            color: #0f766e; /* Teal */
            font-weight: 500;
        }
        
        #performance-details-container {
            padding-bottom: 5vw;
        }
        
        /* Bottom Navigation Bar Styling */
        #bottom-nav-bar {
            flex-shrink: 0; /* Prevent shrinking */
            height: auto; /* Auto height to fit content */
            width: 100%;
            background-color: #d0d0d0; /* Match container background */
            padding: 2vw 2vw; /* 2vw top/bottom, 3vw left/right */
            box-sizing: border-box;
            z-index: 20;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        /* Class for nav content blocks */
        .nav-content {
            width: 100%;
            display: flex;
            align-items: center;
        }

        .back-icon-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #6b7280; /* Gray-500 */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease, color 0.2s ease; /* Added color transition */
            border: none;
            cursor: pointer;
            z-index: 10; 
        }
        .back-icon-button:hover {
            background-color: #4b5563; /* Gray-600 */
        }

        /* Welcome Nav Button Style */
        #go-to-lobby-from-welcome {
            background-color: #3b82f6; /* Blue-500 */
        }
        #go-to-lobby-from-welcome:hover {
            background-color: #2563eb; /* Blue-600 */
        }

        /* --- Dark Mode Styles for Nav Bar --- */
        #bottom-nav-bar.dark-mode-nav {
            background-color: #000000;
            border-top-color: #333;
        }
        
        /* Invert icon button colors */
        #bottom-nav-bar.dark-mode-nav .back-icon-button {
            background-color: #333; /* Dark gray */
            color: #d0d0d0; /* Light text */
        }
        #bottom-nav-bar.dark-mode-nav .back-icon-button:hover {
            background-color: #555; /* Lighter gray on hover */
        }

        /* --- Toggle Switch Styles --- */
        .toggle-dot {
            transition: transform 0.2s ease-in-out;
            transform: translateX(0px);
        }
        input:checked ~ .toggle-dot {
            transform: translateX(24px); 
        }
        .toggle-bg {
            transition: background-color 0.2s ease-in-out;
        }
        
        /* --- Dark Mode Emoji Toggle --- */
        #reader-nav .light-mode-emoji {
            display: inline;
        }
        #reader-nav .dark-mode-emoji {
            display: none;
        }
        #bottom-nav-bar.dark-mode-nav #reader-nav .light-mode-emoji {
            display: none;
        }
        #bottom-nav-bar.dark-mode-nav #reader-nav .dark-mode-emoji {
            display: inline;
        }
        /* --- End Toggle Switch Styles --- */
        
        #typewriter-output {
            font-family: 'Space Grotesk', monospace;
            font-size: 3.3rem; 
            min-height: 8rem; 
            white-space: pre-wrap;
            overflow: hidden;
            border-right: none; 
            line-height: 1.1; 
            display: inline-block;
            transition: none; 
            padding-right: 2px;
        }
        
        .welcome-start-button {
            background-color: #4f46e5; /* Indigo */
            color: white;
            padding: 16px 30px; 
            border-radius: 12px;
            font-size: 1.5rem; 
            font-weight: 600; 
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
            font-family: 'Sora', sans-serif; 
            width: 66.6666%; /* w-2/3 equivalent */
        }
        .welcome-start-button:hover {
            background-color: #4338ca; 
        }

        /* --- Reader Page Styles --- */
        #reader-top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Changed for hamburger & title layout */
            gap: 12px; /* Gap between hamburger and title */
            padding: 1rem 1.5rem; /* Expanded padding for height */
            border-bottom: 1px solid #b4b4b4;
            background-color: #d0d0d0;
            flex-shrink: 0; 
            min-height: 80px; /* Expanded height for 2 lines */
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            position: relative;
            z-index: 30; /* Above the overlay content */
        }

        #reader-title {
            font-size: 1.1rem; /* text-lg */
            font-weight: 600;
            color: #333333;
            text-align: center;
            
            /* Support 2 lines */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            white-space: normal; /* Allow wrapping */
            line-height: 1.3;
            
            flex-grow: 1; /* Take remaining space */
            transition: color 0.3s ease;
        }

        /* New Hamburger Button Style */
        .hamburger-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: transparent; 
            color: #4b5563; /* Gray-600 */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease, color 0.2s ease;
            border: 2px solid #9ca3af; /* Add border to match size visual */
            cursor: pointer;
            flex-shrink: 0;
        }
        .hamburger-button:hover {
            background-color: rgba(0,0,0,0.05);
            color: #1f2937;
        }

        /* Placeholder spacer to balance the title centering */
        .reader-top-spacer {
            width: 48px;
            height: 48px;
            flex-shrink: 0;
        }

        /* Reader Content Wrapper to hold overlay and content */
        #reader-wrapper {
            position: relative;
            flex-grow: 1;
            overflow: hidden; /* Hide overflow of overlay */
            display: flex;
        }

        #reader-content-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            color: #333;
            transition: color 0.3s ease;
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        #reader-content-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari */
        }
        
        /* --- Anchor Links Overlay --- */
        #reader-anchor-overlay {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 50%; /* Half screen width */
            background-color: #e5e5e5; /* Slightly distinct from bg */
            z-index: 25; /* Above content */
            
            transform: translateX(-100%); /* Hidden by default */
            transition: transform 0.3s ease-in-out;
            
            overflow-y: auto;
            border-right: 1px solid #b4b4b4;
            padding: 20px;
            box-sizing: border-box;
            
            /* Hide scrollbar */
            -ms-overflow-style: none; 
            scrollbar-width: none; 
        }
        #reader-anchor-overlay::-webkit-scrollbar {
            display: none;
        }
        
        #reader-anchor-overlay.open {
            transform: translateX(0);
        }

        .anchor-section-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
            margin-bottom: 12px;
            margin-top: 20px;
            font-weight: 700;
        }
        .anchor-section-title:first-child {
            margin-top: 0;
        }

        .anchor-link-item {
            display: block;
            padding: 8px 0;
            color: #374151;
            text-decoration: none;
            font-size: 0.95rem;
            border-bottom: 1px solid #d1d5db;
            transition: color 0.2s ease, padding-left 0.2s ease;
            cursor: pointer;
        }
        .anchor-link-item:hover {
            color: #2563eb; /* Blue */
            padding-left: 4px;
        }
        .anchor-link-h2 {
            padding-left: 16px; /* Indent H2 */
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .anchor-link-h2:hover {
            padding-left: 20px;
        }


        /* --- Notes Content Formatting --- */
        #reader-content-container h1 {
            font-family: 'Sora', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 16px;
            border-bottom: 2px solid #b4b4b4;
            padding-bottom: 8px;
            transition: color 0.3s ease, border-color 0.3s ease; /* Added transition */
        }
        #reader-content-container h2 {
            font-family: 'Sora', sans-serif;
            font-size: 1.4rem;
            font-weight: 600;
            margin-top: 24px;
            margin-bottom: 12px;
            transition: color 0.3s ease; /* Added transition */
        }
        #reader-content-container p, #reader-content-container ul {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 16px;
            transition: color 0.3s ease; /* Added transition */
        }
        #reader-content-container ul {
            list-style-type: disc;
            padding-left: 20px;
        }
        #reader-content-container li {
            margin-bottom: 8px;
        }
        #reader-content-container strong {
            font-weight: 700;
            color: #000;
            transition: color 0.3s ease; /* Added transition */
        }
        #reader-content-container code {
            font-family: 'Space Grotesk', monospace;
            background-color: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: color 0.3s ease, background-color 0.3s ease; /* Added transition */
        }
        /* Style for italics (<em> tags) */
        #reader-content-container em {
            font-style: italic;
        }

        /* --- Table Styles for Markdown --- */
        #reader-content-container table {
            width: 100%;
            border-collapse: collapse; /* Ensures borders merge */
            margin-bottom: 16px;
            font-size: 0.9rem; /* Slightly smaller text for tables */
        }
        #reader-content-container th,
        #reader-content-container td {
            border: 0.5px solid #454545; /* Your specified border */
            padding: 8px 12px;
            text-align: left;
            transition: color 0.3s ease, border-color 0.3s ease; /* Added transition */
        }
        #reader-content-container th {
            background-color: #e5e7eb; /* Light gray header */
            font-weight: 600;
            transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; /* Added transition */
        }
        /* --- End Table Styles --- */

        /* --- End Reader Page Styles --- */
        
        
        /* --- Dark Mode Styles (Reader Only) --- */
        #reader-screen.dark-mode {
            background-color: #000000;
        }
        
        #reader-screen.dark-mode #reader-top-bar {
            background-color: #000000;
            border-bottom-color: #333; /* Darker border */
        }
        
        #reader-screen.dark-mode #reader-title {
            color: #d0d0d0;
        }
        
        #reader-screen.dark-mode .hamburger-button {
            color: #d0d0d0;
            border-color: #4b5563;
        }
        #reader-screen.dark-mode .hamburger-button:hover {
            background-color: rgba(255,255,255,0.1);
            color: white;
        }

        #reader-screen.dark-mode #reader-anchor-overlay {
            background-color: #1a1a1a;
            border-right-color: #333;
        }
        #reader-screen.dark-mode .anchor-section-title {
            color: #9ca3af;
        }
        #reader-screen.dark-mode .anchor-link-item {
            color: #d1d5db;
            border-bottom-color: #374151;
        }
        #reader-screen.dark-mode .anchor-link-item:hover {
            color: #60a5fa; /* Blue-400 */
        }

        #reader-screen.dark-mode #reader-content-container {
            color: #d0d0d0;
        }

        /* Content formatting */
        #reader-screen.dark-mode #reader-content-container h1,
        #reader-screen.dark-mode #reader-content-container h2,
        #reader-screen.dark-mode #reader-content-container p,
        #reader-screen.dark-mode #reader-content-container ul,
        #reader-screen.dark-mode #reader-content-container li {
            color: #d0d0d0;
        }

        #reader-screen.dark-mode #reader-content-container h1 {
            border-bottom-color: #333;
        }
        
        #reader-screen.dark-mode #reader-content-container strong {
            color: #ffffff; /* Brighter for emphasis */
        }
        
        #reader-screen.dark-mode #reader-content-container code {
            background-color: #222;
            color: #d0d0d0;
        }
        
        /* Table Styles */
        #reader-screen.dark-mode #reader-content-container th {
            background-color: #222;
            color: #d0d0d0;
            border-color: #444;
        }
        #reader-screen.dark-mode #reader-content-container td {
            color: #d0d0d0;
            border-color: #444;
        }
        
        /* --- End Dark Mode Styles --- */
        
    </style>
</head>
<body class="antialiased">
    <!-- Main container is now fluid -->
    <div id="quiz-app" class="quiz-container"> 

        <!-- Main Content Area (for screens) -->
        <div id="main-content-area" class="flex-grow relative overflow-hidden">

            <!-- Welcome Screen (No changes to its own content) -->
            <div id="welcome-screen" class="screen current justify-between items-center pt-20 pb-10">
                <div class="text-center">
                    <h1 class="text-7xl text-gray-800" style="font-family: 'Sora', sans-serif;">
                        <span class="font-light" style="font-weight: 300;">Circle</span><span class="font-black italic" style="font-weight: 900;">10</span>
                    </h1>
                    <p class="text-sm text-gray-600 mb-1">AltSchool Africa &bull; Karatu 2025 &bull; Cybersecurity</p>
                    <p class="text-sm text-gray-400 mb-8">&bull; published by Jeffrey O &bull;</p>

                    <div class="h-auto text-gray-500 font-bold mb-10">
                        <span id="typewriter-output"></span>
                    </div>
                </div>
            </div>

            <!-- Lobby Screen -->
            <div id="lobby-screen" class="screen right text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 flex-shrink-0 px-[2vw]">LOBBY</h1>
                <p class="text-lg text-gray-700 mb-8 flex-shrink-0 px-[2vw]">What will YOU explore?</p>
                
                <div class="lobby-buttons">
                    <!-- Notes Card -->
                    <button id="go-to-notes-button" class="quiz-card-base quiz-card-lobby" style="grid-column: 1 / span 1; aspect-ratio: 1 / 1;">
                        <span class="card-title">Notes</span>
                        <span class="card-subtitle">Study & gain mastery!</span>
                    </button>
                    <!-- Decks Card -->
                    <button id="go-to-decks-button" class="quiz-card-base quiz-card-lobby" style="grid-column: 2 / span 1; aspect-ratio: 1 / 1;">
                        <span class="card-title">Decks</span>
                        <span class="card-subtitle">Revisit the live classes!</span>
                    </button>
                    <!-- Tests Card -->
                    <button id="go-to-tests-button" class="quiz-card-base quiz-card-lobby" style="grid-column: 1 / span 1; aspect-ratio: 1 / 1;">
                        <span class="card-title">Tests</span>
                        <span class="card-subtitle">Take on a challenge!</span>
                    </button>
                    <!-- Miscellaneous Card -->
                    <button id="go-to-misc-button" class="quiz-card-base quiz-card-lobby" style="grid-column: 2 / span 1; aspect-ratio: 1 / 1;">
                        <span class="card-title">Miscellaneous</span>
                        <span class="card-subtitle">All the other stuff!</span>
                    </button>
                </div>
            </div>

            <!-- Notes Screen -->
            <div id="notes-screen" class="screen right text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 flex-shrink-0 px-[2vw]">NOTES</h1>
                <p class="text-lg text-gray-700 mb-8 flex-shrink-0 px-[2vw]">Pick a domain</p>
                
                <div class="lobby-buttons">
                    <!-- Row 1 (Indigo) -->
                    <button class="quiz-card-base quiz-card-indigo" data-note-file="Fundamentals_of_Network_Security_notes.md" data-note-title="Fundamentals of Network Security">
                        <span class="card-subtitle">CYS 520 &bull; Week 1</span>
                        <span class="card-title">Fundamentals of Network Security</span>
                    </button>
                    <button class="quiz-card-base quiz-card-indigo" data-note-file="Network_Security_Devices_and_Technologies_notes.md" data-note-title="Network Security Devices and Technologies">
                        <span class="card-subtitle">CYS 520 &bull; Week 2</span>
                        <span class="card-title">Network Security Devices and Technologies</span>
                    </button>
                    <!-- Row 2 (Indigo) -->
                    <button class="quiz-card-base quiz-card-indigo" data-note-file="Introduction_to_Cryptography_notes.md" data-note-title="Introduction to Cryptography">
                        <span class="card-subtitle">CYS 520 &bull; Week 3</span>
                        <span class="card-title">Introduction to Cryptography</span>
                    </button>
                    <button class="quiz-card-base quiz-card-indigo" data-note-file="Cryptographic_Applications_notes.md" data-note-title="Cryptographic Applications">
                        <span class="card-subtitle">CYS 520 &bull; Week 4</span>
                        <span class="card-title">Cryptographic Applications</span>
                    </button>
                    <!-- Row 3 (Orange) -->
                    <button class="quiz-card-base quiz-card-orange" data-note-file="Endpoint_Security_notes.md" data-note-title="Endpoint Security">
                        <span class="card-subtitle">CYS 525 &bull; Week 1</span>
                        <span class="card-title">Endpoint Security</span>
                    </button>
                    <button class="quiz-card-base quiz-card-orange" data-note-file="Advanced_Endpoint_Security_notes.md" data-note-title="Advanced Endpoint Security">
                        <span class="card-subtitle">CYS 525 &bull; Week 2</span>
                        <span class="card-title">Advanced Endpoint Security</span>
                    </button>
                    <!-- Row 4 (Orange) -->
                    <button class="quiz-card-base quiz-card-orange" data-note-file="Standards_Regulations_and_Data_Privacy_notes.md" data-note-title="Standards, Regulations and Data Privacy">
                        <span class="card-subtitle">CYS 525 &bull; Week 3</span>
                        <span class="card-title">Standards, Regulations and Data Privacy</span>
                    </button>
                    <button class="quiz-card-base quiz-card-orange opacity-50 cursor-not-allowed">
                        <span class="card-subtitle">CYS 525 &bull; Week 4</span>
                        <span class="card-title">Data Privacy and Professional Issues</span>
                    </button>
                </div>
            </div>

            <!-- Decks Screen -->
            <div id="decks-screen" class="screen right text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 flex-shrink-0 px-[2vw]">DECKS</h1>
                <p class="text-lg text-gray-700 mb-8 flex-shrink-0 px-[2vw]">Transcribed & structured live-class decks</p>
                
                <div class="lobby-buttons">
                    <!-- Row 1 (Indigo) -->
                    <button class="quiz-card-base quiz-card-indigo" data-note-file="Fundamentals_of_Network_Security_deck.md" data-note-title="Fundamentals of Network Security">
                        <span class="card-subtitle">CYS 520 &bull; Week 1</span>
                        <span class="card-title">Fundamentals of Network Security</span>
                    </button>
                    <button class="quiz-card-base quiz-card-indigo" data-note-file="Network_Security_Devices_and_Technologies_deck.md" data-note-title="Network Security Devices">
                        <span class="card-subtitle">CYS 520 &bull; Week 2</span>
                        <span class="card-title">Network Security Devices and Technologies</span>
                    </button>
                    <!-- Row 2 (Indigo) -->
                    <button class="quiz-card-base quiz-card-indigo" data-note-file="Introduction_to_Cryptography_deck.md" data-note-title="Introduction to Cryptography">
                        <span class="card-subtitle">CYS 520 &bull; Week 3</span>
                        <span class="card-title">Introduction to Cryptography</span>
                    </button>
                    <button class="quiz-card-base quiz-card-indigo" data-note-file="Cryptographic_Applications_deck.md" data-note-title="Cryptographic Applications">
                        <span class="card-subtitle">CYS 520 &bull; Week 4</span>
                        <span class="card-title">Cryptographic Applications</span>
                    </button>
                    <!-- Row 3 (Orange) -->
                    <button class="quiz-card-base quiz-card-orange" data-note-file="Endpoint_Security_deck.md" data-note-title="Endpoint Security">
                        <span class="card-subtitle">CYS 525 &bull; Week 1</span>
                        <span class="card-title">Endpoint Security</span>
                    </button>
                    <button class="quiz-card-base quiz-card-orange opacity-50 cursor-not-allowed">
                        <span class="card-subtitle">CYS 525 &bull; Week 2</span>
                        <span class="card-title">Advanced Endpoint Security</span>
                    </button>
                    <!-- Row 4 (Orange) -->
                    <button class="quiz-card-base quiz-card-orange opacity-50 cursor-not-allowed">
                        <span class="card-subtitle">CYS 525 &bull; Week 3</span>
                        <span class="card-title">Standards, Regulations and Data Privacy</span>
                    </button>
                    <button class="quiz-card-base quiz-card-orange opacity-50 cursor-not-allowed">
                        <span class="card-subtitle">CYS 525 &bull; Week 4</span>
                        <span class="card-title">Data Privacy and Professional Issues</span>
                    </button>
                </div>
            </div>

            <!-- Miscellaneous Screen -->
            <div id="misc-screen" class="screen right text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 flex-shrink-0 px-[2vw]">MISCELLANEOUS</h1>
                <p class="text-lg text-gray-700 mb-8 flex-shrink-0 px-[2vw]">Labs, Guides and so on...</p>
                
                <div class="lobby-buttons">
                    <!-- Card 0 -->
                    <button class="quiz-card-base quiz-card-darkgreen" style="grid-column: 1 / span 2; aspect-ratio: 4 / 1;" data-note-file="Official_2nd_Semester_Assessment_Checklist.md" data-note-title="Official: 2nd Semester Assessment Checklist">
                        <span class="card-title">Official: 2nd Semester Assessment Checklist</span>
                        <span class="card-subtitle">Assessment guide to whatâ€™s coming</span>
                    </button>
                    <!-- Card 1 -->
                    <button class="quiz-card-base quiz-card-darkgreen opacity-50 cursor-not-allowed" style="grid-column: 1 / span 2; aspect-ratio: 4 / 1;">
                        <span class="card-title">Lab: Network Traffic Analysis</span>
                        <span class="card-subtitle">Network traffic analysis using Wireshark</span>
                    </button>
                    <!-- Card 2 -->
                    <button class="quiz-card-base quiz-card-darkgreen opacity-50 cursor-not-allowed" style="grid-column: 1 / span 2; aspect-ratio: 4 / 1;">
                        <span class="card-title">Lab: Threat Simulation</span>
                        <span class="card-subtitle">ARP Spoofing (Bettercap) and traffic analysis (Wireshark)</span>
                    </button>
                    <!-- Card 3 -->
                    <button class="quiz-card-base quiz-card-darkgreen" style="grid-column: 1 / span 2; aspect-ratio: 4 / 1;" data-note-file="Lab_Encryption_on_Kali_Linux.md" data-note-title="Lab: Encryption on Kali Linux">
                        <span class="card-title">Lab: Encryption on Kali Linux</span>
                        <span class="card-subtitle">Symmetric & Asymmetric Encryption, & PKI</span>
                    </button>
                    <!-- Card 4 -->
                    <button class="quiz-card-base quiz-card-darkgreen" style="grid-column: 1 / span 2; aspect-ratio: 4 / 1;" data-note-file="Lab_TLS_SSL_VPN_&_Traffic_Analysis.md" data-note-title="Lab: TLS/SSL, VPN & Traffic Analysis">
                        <span class="card-title">Lab: TLS/SSL, VPN & Traffic Analysis</span>
                        <span class="card-subtitle">Configurations using Kali Linux and Wireshark</span>
                    </button>
                    <!-- Card 5 -->
                    <button class="quiz-card-base quiz-card-darkgreen" style="grid-column: 1 / span 2; aspect-ratio: 4 / 1;" data-note-file="Guide_Next-Gen_Firewall_Setup.md" data-note-title="Guide: Next-Gen Firewall Setup">
                        <span class="card-title">Guide: Next-Gen Firewall Setup</span>
                        <span class="card-subtitle">Adding & configuring Sophos Virtual Firewall</span>
                    </button>
                    <!-- Card 6 -->
                    <button class="quiz-card-base quiz-card-darkgreen" style="grid-column: 1 / span 2; aspect-ratio: 4 / 1;" data-note-file="Guide_Sophos_Central_Registration.md" data-note-title="Guide: Sophos Central Registration">
                        <span class="card-title">Guide: Sophos Central Registration</span>
                        <span class="card-subtitle">Completing registration for full access</span>
                    </button>
                    <!-- Card 7 -->
                    <button class="quiz-card-base quiz-card-darkgreen" style="grid-column: 1 / span 2; aspect-ratio: 4 / 1;" data-note-file="Guide_Sophos_Firewall_Security_Configuration_1.md" data-note-title="Guide: Sophos Firewall Security Configuration 1">
                        <span class="card-title">Guide: Sophos Firewall Security Configuration 1</span>
                        <span class="card-subtitle">Configuring 3 security policies</span>
                    </button>
                    <!-- Card 8 -->
                    <button class="quiz-card-base quiz-card-darkgreen" style="grid-column: 1 / span 2; aspect-ratio: 4 / 1;" data-note-file="Guide_Sophos_Firewall_Security_Configuration_2.md" data-note-title="Guide: Sophos Firewall Security Configuration 2">
                        <span class="card-title">Guide: Sophos Firewall Security Configuration 2</span>
                        <span class="card-subtitle">Configuring 2 more security policies</span>
                    </button>
                    <!-- Card 9 -->
                    <button class="quiz-card-base quiz-card-darkgreen opacity-50 cursor-not-allowed" style="grid-column: 1 / span 2; aspect-ratio: 4 / 1;">
                        <span class="card-title">Guide: Sophos Endpoint Security</span>
                        <span class="card-subtitle">Configuring and installing Sophos Endpoint Protection on endpoints</span>
                    </button>
                    <!-- Card 10 -->
                    <button class="quiz-card-base quiz-card-darkgreen" style="grid-column: 1 / span 2; aspect-ratio: 4 / 1;" data-note-file="Guide_Setting_Up_an_AWS_Account.md" data-note-title="Guide: Setting Up an AWS Account">
                        <span class="card-title">Guide: Setting Up an AWS Account</span>
                        <span class="card-subtitle">Registering an AWS account to access cloud services</span>
                    </button>
                    <!-- Card 11 -->
                    <button class="quiz-card-base quiz-card-darkgreen" style="grid-column: 1 / span 2; aspect-ratio: 4 / 1;" data-note-file="Guide_Wazuh_SIEM_&_Agents.md" data-note-title="Guide: Wazuh SIEM & Agents">
                        <span class="card-title">Guide: Wazuh SIEM & Agents</span>
                        <span class="card-subtitle">Deploying Wazuh Server on AWS EC2 & Adding Agents on Local VMs</span>
                    </button>
                </div>
            </div>

            <!-- Tests Screen -->
            <div id="tests-screen" class="screen right text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 flex-shrink-0 px-[2vw]">TESTS</h1>
                <p class="text-lg text-gray-700 mb-8 flex-shrink-0 px-[2vw]">Take on a challenge!</p>
                
                <div class="lobby-buttons">
                    <!-- Row 1 (Indigo) -->
                    <button class="quiz-card-base quiz-card-indigo" data-quiz-category="Fundamentals_of_Network_Security">
                        <span class="card-subtitle">CYS 520 &bull; Week 1</span>
                        <span class="card-title">Fundamentals of Network Security</span>
                    </button>
                    <button class="quiz-card-base quiz-card-indigo" data-quiz-category="Network_Security_Devices_and_Technologies">
                        <span class="card-subtitle">CYS 520 &bull; Week 2</span>
                        <span class="card-title">Network Security Devices and Technologies</span>
                    </button>
                    <!-- Row 2 (Indigo) -->
                    <button class="quiz-card-base quiz-card-indigo" data-quiz-category="Introduction_to_Cryptography">
                        <span class="card-subtitle">CYS 520 &bull; Week 3</span>
                        <span class="card-title">Introduction to Cryptography</span>
                    </button>
                    <button class="quiz-card-base quiz-card-indigo" data-quiz-category="Cryptographic_Applications">
                        <span class="card-subtitle">CYS 520 &bull; Week 4</span>
                        <span class="card-title">Cryptographic Applications</span>
                    </button>
                    <!-- Row 3 (Orange) -->
                    <button class="quiz-card-base quiz-card-orange" data-quiz-category="Endpoint_Security">
                        <span class="card-subtitle">CYS 525 &bull; Week 1</span>
                        <span class="card-title">Endpoint Security</span>
                    </button>
                    <button class="quiz-card-base quiz-card-orange" data-quiz-category="Advanced_Endpoint_Security">
                        <span class="card-subtitle">CYS 525 &bull; Week 2</span>
                        <span class="card-title">Advanced Endpoint Security</span>
                    </button>
                    <!-- Row 4 (Orange) -->
                    <button class="quiz-card-base quiz-card-orange" data-quiz-category="Standards_Regulations_and_Data_Privacy">
                        <span class="card-subtitle">CYS 525 &bull; Week 3</span>
                        <span class="card-title">Standards, Regulations and Data Privacy</span>
                    </button>
                    <button class="quiz-card-base quiz-card-orange opacity-50 cursor-not-allowed" data-quiz-category="Data_Privacy_and_Professional_Issues">
                        <span class="card-subtitle">CYS 525 &bull; Week 4</span>
                        <span class="card-title">Data Privacy and Professional Issues</span>
                    </button>

                    <p id="loading-message" class="text-sm text-gray-600 col-span-full hidden">Loading quiz data...</p>
                </div>
            </div>

            <!-- Format Screen -->
            <div id="format-screen" class="screen right text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 flex-shrink-0 px-[2vw]">TEST FORMAT</h1>
                <p class="text-lg text-gray-700 mb-8 flex-shrink-0 px-[2vw]">Pick a Format</p>
                
                <div class="lobby-buttons">
                    <!-- Row 1 -->
                    <button class="format-card-button" data-questions="5" data-time="2">
                        <span class="card-subtitle">5 questions &bull; 2 minutes</span>
                        <span class="card-title">Mini Quiz</span>
                    </button>
                    <button class="format-card-button" data-questions="10" data-time="5">
                        <span class="card-subtitle">10 questions &bull; 5 minutes</span>
                        <span class="card-title">Pop Quiz</span>
                    </button>
                    <!-- Row 2 -->
                    <button class="format-card-button" data-questions="15" data-time="10">
                        <span class="card-subtitle">15 questions &bull; 10 minutes</span>
                        <span class="card-title">Test</span>
                    </button>
                    <button class="format-card-button" data-questions="40" data-time="30">
                        <span class="card-subtitle">40 questions &bull; 30 minutes</span>
                        <span class="card-title">Exam</span>
                    </button>
                    <!-- Row 3 - Surfing Card -->
                    <button class="format-card-button surfing-card" data-questions="unlimited" data-time="unlimited">
                        <span class="card-subtitle">All the questions &bull; All the time</span>
                        <span class="card-title">Surfing!</span>
                    </button>
                </div>
            </div>
            
            <!-- Quiz Screen -->
            <div id="quiz-screen" class="screen right">
                <div id="quiz-main-content">
                    <div class="flex justify-between items-center mb-6">
                        <div class="text-lg font-semibold text-gray-600">Question <span id="current-question-number">1</span> / <span id="total-questions-display"></span></div>
                        <div classV="text-2xl font-bold text-red-600" id="time-left">00:00</div>
                    </div>
                    <h2 id="question-text" class="text-2xl font-semibold text-gray-800 mb-6"></h2>
                    
                    <div id="options-container" class="grid gap-4">
                        <button class="option-button"></button>
                        <button class="option-button"></button>
                        <button class="option-button"></button>
                        <button class="option-button"></button>
                    </div>
                </div>
            </div>

            <!-- Results Screen -->
            <div id="results-screen" class="screen right text-center justify-between">
                <div class="flex-grow flex flex-col justify-center items-center">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Done!</h2> 
                    <p id="results-subtitle" class="text-lg text-gray-700 mb-4 px-[2vw]"></p> 
                    
                    <p class="text-8xl font-bold mb-4 score-indigo-text" style="font-family: 'Sora', sans-serif;">
                        <span id="final-score-percentage"></span>%
                    </p>

                    <p class="text-lg text-gray-600 mb-2">You got <span id="correct-answers-count" class="font-bold score-indigo-text"></span> out of <span id="total-questions-results" class="font-bold score-indigo-text"></span> right!</p>
                    <p class="text-lg text-gray-600 mb-6" id="time-taken-results"></p>
                </div>
            </div>

            <!-- Performance Screen -->
            <div id="performance-screen" class="screen right">
                <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center flex-shrink-0">Your Performance</h2> 
                <p id="performance-subtitle" class="text-lg text-gray-700 mb-6 text-center flex-shrink-0 px-[2vw]"></p> 
                <div id="performance-details-container" class="mt-4 flex-grow" style="overflow-y: auto; -ms-overflow-style: none; scrollbar-width: none;">
                    <!-- Performance items will be injected here -->
                </div>
            </div>

            <!-- Reader Screen -->
            <div id="reader-screen" class="screen right">
                <!-- Top Bar -->
                <div id="reader-top-bar">
                    <!-- Hamburger Button -->
                    <button id="reader-hamburger-button" class="hamburger-button">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                        </svg>
                    </button>
                    <!-- Title -->
                    <h1 id="reader-title" class="truncate">Loading...</h1>
                    <!-- Spacer -->
                    <div class="reader-top-spacer"></div>
                </div>
                
                <!-- Content Wrapper -->
                <div id="reader-wrapper">
                    <!-- Anchor Overlay -->
                    <div id="reader-anchor-overlay">
                        <!-- Links will be injected here -->
                    </div>
                    
                    <!-- Scrollable Content -->
                    <div id="reader-content-container">
                        <p>Loading notes...</p>
                    </div>
                </div>
            </div>

        </div> <!-- End #main-content-area -->


        <!-- Persistent Bottom Navigation Bar -->
        <div id="bottom-nav-bar"> 

            <!-- Welcome Nav Content -->
            <div id="welcome-nav" class="nav-content hidden w-full justify-center items-center">
                <button id="go-to-lobby-from-welcome" class="back-icon-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            
            <!-- Lobby Nav Content -->
            <div id="lobby-nav" class="nav-content hidden w-full justify-between items-center">
                <button id="back-to-welcome-from-lobby" class="back-icon-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M7.72 12.53a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 1 1 1.06 1.06L9.31 12l6.97 6.97a.75.75 0 1 1-1.06 1.06l-7.5-7.5Z" clip-rule="evenodd" />
                    </svg>
                </button>

                <button class="fullscreen-toggle-button back-icon-button">
                    <svg class="fullscreen-open-icon w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path fill-rule="evenodd" d="M3.75 6.75a3 3 0 0 1 3-3h3.75a.75.75 0 0 1 0 1.5h-3.75a1.5 1.5 0 0 0-1.5 1.5v3.75a.75.75 0 0 1-1.5 0v-3.75Zm16.5 0a3 3 0 0 0-3-3h-3.75a.75.75 0 0 0 0 1.5h3.75a1.5 1.5 0 0 1 1.5 1.5v3.75a.75.75 0 0 0 1.5 0v-3.75Zm-16.5 10.5a3 3 0 0 0 3 3h3.75a.75.75 0 0 0 0-1.5h-3.75a1.5 1.5 0 0 1-1.5-1.5v-3.75a.75.75 0 0 0-1.5 0v3.75Zm16.5 0a3 3 0 0 1-3 3h-3.75a.75.75 0 0 1 0-1.5h3.75a1.5 1.5 0 0 0 1.5-1.5v-3.75a.75.75 0 0 1 1.5 0v3.75Z" clip-rule="evenodd" />
                    </svg>
                    <svg class="fullscreen-close-icon w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <!-- Notes Nav Content -->
            <div id="notes-nav" class="nav-content hidden w-full justify-between items-center">
                <button id="back-to-lobby-from-notes" class="back-icon-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M7.72 12.53a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 1 1 1.06 1.06L9.31 12l6.97 6.97a.75.75 0 1 1-1.06 1.06l-7.5-7.5Z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button class="fullscreen-toggle-button back-icon-button">
                    <svg class="fullscreen-open-icon w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path fill-rule="evenodd" d="M3.75 6.75a3 3 0 0 1 3-3h3.75a.75.75 0 0 1 0 1.5h-3.75a1.5 1.5 0 0 0-1.5 1.5v3.75a.75.75 0 0 1-1.5 0v-3.75Zm16.5 0a3 3 0 0 0-3-3h-3.75a.75.75 0 0 0 0 1.5h3.75a1.5 1.5 0 0 1 1.5 1.5v3.75a.75.75 0 0 0 1.5 0v-3.75Zm-16.5 10.5a3 3 0 0 0 3 3h3.75a.75.75 0 0 0 0-1.5h-3.75a1.5 1.5 0 0 1-1.5-1.5v-3.75a.75.75 0 0 0-1.5 0v3.75Zm16.5 0a3 3 0 0 1-3 3h-3.75a.75.75 0 0 1 0-1.5h3.75a1.5 1.5 0 0 0 1.5-1.5v-3.75a.75.75 0 0 1 1.5 0v3.75Z" clip-rule="evenodd" />
                    </svg>
                    <svg class="fullscreen-close-icon w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <!-- Decks Nav Content -->
            <div id="decks-nav" class="nav-content hidden w-full justify-between items-center">
                <button id="back-to-lobby-from-decks" class="back-icon-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M7.72 12.53a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 1 1 1.06 1.06L9.31 12l6.97 6.97a.75.75 0 1 1-1.06 1.06l-7.5-7.5Z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button class="fullscreen-toggle-button back-icon-button">
                    <svg class="fullscreen-open-icon w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path fill-rule="evenodd" d="M3.75 6.75a3 3 0 0 1 3-3h3.75a.75.75 0 0 1 0 1.5h-3.75a1.5 1.5 0 0 0-1.5 1.5v3.75a.75.75 0 0 1-1.5 0v-3.75Zm16.5 0a3 3 0 0 0-3-3h-3.75a.75.75 0 0 0 0 1.5h3.75a1.5 1.5 0 0 1 1.5 1.5v3.75a.75.75 0 0 0 1.5 0v-3.75Zm-16.5 10.5a3 3 0 0 0 3 3h3.75a.75.75 0 0 0 0-1.5h-3.75a1.5 1.5 0 0 1-1.5-1.5v-3.75a.75.75 0 0 0-1.5 0v3.75Zm16.5 0a3 3 0 0 1-3 3h-3.75a.75.75 0 0 1 0-1.5h3.75a1.5 1.5 0 0 0 1.5-1.5v-3.75a.75.75 0 0 1 1.5 0v3.75Z" clip-rule="evenodd" />
                    </svg>
                    <svg class="fullscreen-close-icon w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <!-- NEW: Miscellaneous Nav Content -->
            <div id="misc-nav" class="nav-content hidden w-full justify-between items-center">
                <button id="back-to-lobby-from-misc" class="back-icon-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M7.72 12.53a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 1 1 1.06 1.06L9.31 12l6.97 6.97a.75.75 0 1 1-1.06 1.06l-7.5-7.5Z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button class="fullscreen-toggle-button back-icon-button">
                    <svg class="fullscreen-open-icon w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path fill-rule="evenodd" d="M3.75 6.75a3 3 0 0 1 3-3h3.75a.75.75 0 0 1 0 1.5h-3.75a1.5 1.5 0 0 0-1.5 1.5v3.75a.75.75 0 0 1-1.5 0v-3.75Zm16.5 0a3 3 0 0 0-3-3h-3.75a.75.75 0 0 0 0 1.5h3.75a1.5 1.5 0 0 1 1.5 1.5v3.75a.75.75 0 0 0 1.5 0v-3.75Zm-16.5 10.5a3 3 0 0 0 3 3h3.75a.75.75 0 0 0 0-1.5h-3.75a1.5 1.5 0 0 1-1.5-1.5v-3.75a.75.75 0 0 0-1.5 0v3.75Zm16.5 0a3 3 0 0 1-3 3h-3.75a.75.75 0 0 1 0-1.5h3.75a1.5 1.5 0 0 0 1.5-1.5v-3.75a.75.75 0 0 1 1.5 0v3.75Z" clip-rule="evenodd" />
                    </svg>
                    <svg class="fullscreen-close-icon w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <!-- Tests Nav Content -->
            <div id="tests-nav" class="nav-content hidden w-full justify-between items-center">
                <button id="back-to-lobby-from-tests" class="back-icon-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M7.72 12.53a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 1 1 1.06 1.06L9.31 12l6.97 6.97a.75.75 0 1 1-1.06 1.06l-7.5-7.5Z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button class="fullscreen-toggle-button back-icon-button">
                    <svg class="fullscreen-open-icon w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path fill-rule="evenodd" d="M3.75 6.75a3 3 0 0 1 3-3h3.75a.75.75 0 0 1 0 1.5h-3.75a1.5 1.5 0 0 0-1.5 1.5v3.75a.75.75 0 0 1-1.5 0v-3.75Zm16.5 0a3 3 0 0 0-3-3h-3.75a.75.75 0 0 0 0 1.5h3.75a1.5 1.5 0 0 1 1.5 1.5v3.75a.75.75 0 0 0 1.5 0v-3.75Zm-16.5 10.5a3 3 0 0 0 3 3h3.75a.75.75 0 0 0 0-1.5h-3.75a1.5 1.5 0 0 1-1.5-1.5v-3.75a.75.75 0 0 0-1.5 0v3.75Zm16.5 0a3 3 0 0 1-3 3h-3.75a.75.75 0 0 1 0-1.5h3.75a1.5 1.5 0 0 0 1.5-1.5v-3.75a.75.75 0 0 1 1.5 0v3.75Z" clip-rule="evenodd" />
                    </svg>
                    <svg class="fullscreen-close-icon w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <!-- Format Nav Content -->
            <div id="format-nav" class="nav-content hidden w-full justify-between items-center">
                <button id="back-to-tests-from-format" class="back-icon-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M7.72 12.53a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 1 1 1.06 1.06L9.31 12l6.97 6.97a.75.75 0 1 1-1.06 1.06l-7.5-7.5Z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button class="fullscreen-toggle-button back-icon-button">
                    <svg class="fullscreen-open-icon w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path fill-rule="evenodd" d="M3.75 6.75a3 3 0 0 1 3-3h3.75a.75.75 0 0 1 0 1.5h-3.75a1.5 1.5 0 0 0-1.5 1.5v3.75a.75.75 0 0 1-1.5 0v-3.75Zm16.5 0a3 3 0 0 0-3-3h-3.75a.75.75 0 0 0 0 1.5h3.75a1.5 1.5 0 0 1 1.5 1.5v3.75a.75.75 0 0 0 1.5 0v-3.75Zm-16.5 10.5a3 3 0 0 0 3 3h3.75a.75.75 0 0 0 0-1.5h-3.75a1.5 1.5 0 0 1-1.5-1.5v-3.75a.75.75 0 0 0-1.5 0v3.75Zm16.5 0a3 3 0 0 1-3 3h-3.75a.75.75 0 0 1 0-1.5h3.75a1.5 1.5 0 0 0 1.5-1.5v-3.75a.75.75 0 0 1 1.5 0v3.75Z" clip-rule="evenodd" />
                    </svg>
                    <svg class="fullscreen-close-icon w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <!-- Reader Nav Content -->
            <div id="reader-nav" class="nav-content hidden w-full justify-between items-center">
                <!-- Left: Back Button -->
                <button id="back-to-notes-from-reader" class="back-icon-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M7.72 12.53a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 1 1 1.06 1.06L9.31 12l6.97 6.97a.75.75 0 1 1-1.06 1.06l-7.5-7.5Z" clip-rule="evenodd" />
                    </svg>
                </button>
                
                <!-- Center: Dark Mode Toggle Switch -->
                <div class="flex items-center justify-center">
                    <label for="dark-mode-toggle-switch" class="flex items-center cursor-pointer">
                        <span class="mr-2 text-2xl dark-mode-toggle-label">
                            <span class="light-mode-emoji">ðŸŒ•</span>
                            <span class="dark-mode-emoji">ðŸŒ‘</span>
                        </span>
                        <div class="relative">
                            <input type="checkbox" id="dark-mode-toggle-switch" class="sr-only">
                            <div class="toggle-bg block bg-gray-500 w-14 h-8 rounded-full"></div>
                            <div class="toggle-dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full"></div>
                        </div>
                    </label>
                </div>
                
                <!-- Right: Fullscreen button -->
                <button class="fullscreen-toggle-button back-icon-button">
                    <svg class="fullscreen-open-icon w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path fill-rule="evenodd" d="M3.75 6.75a3 3 0 0 1 3-3h3.75a.75.75 0 0 1 0 1.5h-3.75a1.5 1.5 0 0 0-1.5 1.5v3.75a.75.75 0 0 1-1.5 0v-3.75Zm16.5 0a3 3 0 0 0-3-3h-3.75a.75.75 0 0 0 0 1.5h3.75a1.5 1.5 0 0 1 1.5 1.5v3.75a.75.75 0 0 0 1.5 0v-3.75Zm-16.5 10.5a3 3 0 0 0 3 3h3.75a.75.75 0 0 0 0-1.5h-3.75a1.5 1.5 0 0 1-1.5-1.5v-3.75a.75.75 0 0 0-1.5 0v3.75Zm16.5 0a3 3 0 0 1-3 3h-3.75a.75.75 0 0 1 0-1.5h3.75a1.5 1.5 0 0 0 1.5-1.5v-3.75a.75.75 0 0 1 1.5 0v3.75Z" clip-rule="evenodd" />
                    </svg>
                    <svg class="fullscreen-close-icon w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <!-- Quiz Nav Content -->
            <div id="quiz-nav" class="nav-content hidden w-full">
                <div class="flex flex-col sm:flex-row gap-4 w-full">
                    <button id="quit-quiz-button" class="quit-button w-full sm:w-1/4">Quit</button>
                    <button id="submit-answer-button" class="submit-button w-full sm:w-3/4" disabled>Submit</button>
                </div>
            </div>

            <!-- Results Nav Content -->
            <div id="results-nav" class="nav-content hidden w-full">
                <div class="flex flex-row gap-4 w-full">
                    <button id="see-performance-button" class="quiz-card-base quiz-card-indigo w-1/2" style="aspect-ratio: 2 / 1;">
                        <span class="card-title">Performance</span>
                        <span class="card-subtitle">See how you did!</span>
                    </button>
                    <button id="return-to-tests-from-results-button" class="quiz-card-base quiz-card-indigo w-1/2" style="aspect-ratio: 2 / 1;">
                        <span class="card-title">Tests</span>
                        <span class="card-subtitle">Take another test!</span>
                    </button>
                </div>
            </div>

            <!-- Performance Nav Content -->
            <div id="performance-nav" class="nav-content hidden w-full">
                <button id="return-to-tests-from-performance-button" class="quiz-card-base quiz-card-indigo w-full py-4 text-lg font-semibold" style="aspect-ratio: unset; height: auto;">
                    Return to Tests
                </button>
            </div>

        </div> <!-- End #bottom-nav-bar -->


        <!-- Message Box (Stays at root) -->
        <div id="message-box" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full text-center">
                <h3 id="message-title" class="text-2xl font-bold text-gray-800 mb-4"></h3>
                <p id="message-content" class="text-gray-700 mb-6"></p>
                <button id="message-ok-button" class="submit-button w-full">OK</button>
            </div>
        </div>
    </div> <!-- End #quiz-app -->

    <script type="module">
        // --- QUIZ CATEGORY SETUP ---
        const quizCategories = {
            "Fundamentals_of_Network_Security": "Fundamentals_of_Network_Security",
            "Network_Security_Devices_and_Technologies": "Network_Security_Devices_and_Technologies",
            "Introduction_to_Cryptography": "Introduction_to_Cryptography",
            "Cryptographic_Applications": "Cryptographic_Applications",
            "Endpoint_Security": "Endpoint_Security",
            "Advanced_Endpoint_Security": "Advanced_Endpoint_Security",
            "Standards_Regulations_and_Data_Privacy": "Standards_Regulations_and_Data_Privacy",
            "Data_Privacy_and_Professional_Issues": "Data_Privacy_and_Professional_Issues"
        };
        
        // DOM Elements
        const welcomeScreen = document.getElementById('welcome-screen');
        
        // Lobby Screen elements
        const lobbyScreen = document.getElementById('lobby-screen');
        const goToNotesButton = document.getElementById('go-to-notes-button');
        const goToDecksButton = document.getElementById('go-to-decks-button');
        const goToMiscButton = document.getElementById('go-to-misc-button'); 
        const goToTestsButton = document.getElementById('go-to-tests-button');

        // Notes Screen element
        const notesScreen = document.getElementById('notes-screen');
        const notesCategoryButtons = document.querySelectorAll('#notes-screen .quiz-card-base:not(.cursor-not-allowed)');

        // Decks Screen element
        const decksScreen = document.getElementById('decks-screen');
        const decksCategoryButtons = document.querySelectorAll('#decks-screen .quiz-card-base:not(.cursor-not-allowed)');

        // Misc Screen element
        const miscScreen = document.getElementById('misc-screen');
        const miscCategoryButtons = document.querySelectorAll('#misc-screen .quiz-card-base:not(.cursor-not-allowed)');

        // Tests Screen elements
        const testsScreen = document.getElementById('tests-screen');
        const loadingMessage = document.getElementById('loading-message');
        const quizCategoryButtons = document.querySelectorAll('#tests-screen .quiz-card-base:not(.cursor-not-allowed)'); 

        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const performanceScreen = document.getElementById('performance-screen');
        
        // Reader Screen elements
        const readerScreen = document.getElementById('reader-screen');
        const readerTitle = document.getElementById('reader-title');
        const readerContentContainer = document.getElementById('reader-content-container');
        const readerHamburgerButton = document.getElementById('reader-hamburger-button');
        const readerAnchorOverlay = document.getElementById('reader-anchor-overlay');
        
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const optionButtons = optionsContainer.querySelectorAll('.option-button'); 
        
        // --- Nav Bar and Content References ---
        const bottomNavBar = document.getElementById('bottom-nav-bar');
        const welcomeNav = document.getElementById('welcome-nav'); 
        const lobbyNav = document.getElementById('lobby-nav'); 
        const notesNav = document.getElementById('notes-nav');
        const decksNav = document.getElementById('decks-nav');
        const miscNav = document.getElementById('misc-nav'); 
        const readerNav = document.getElementById('reader-nav'); 
        const testsNav = document.getElementById('tests-nav'); 
        const formatNav = document.getElementById('format-nav');
        const quizNav = document.getElementById('quiz-nav');
        const resultsNav = document.getElementById('results-nav');
        const performanceNav = document.getElementById('performance-nav');
        
        // Buttons now referenced from their nav containers
        const submitAnswerButton = quizNav.querySelector('#submit-answer-button');
        const quitQuizButton = quizNav.querySelector('#quit-quiz-button');
        const returnToTestsFromResultsButton = resultsNav.querySelector('#return-to-tests-from-results-button'); 
        const seePerformanceButton = resultsNav.querySelector('#see-performance-button');
        const returnToTestsFromPerformanceButton = performanceNav.querySelector('#return-to-tests-from-performance-button'); 
        const backToWelcomeFromLobby = lobbyNav.querySelector('#back-to-welcome-from-lobby'); 
        const backToLobbyFromNotes = notesNav.querySelector('#back-to-lobby-from-notes');
        const backToLobbyFromDecks = decksNav.querySelector('#back-to-lobby-from-decks');
        const backToLobbyFromMisc = miscNav.querySelector('#back-to-lobby-from-misc'); 
        const backToNotesFromReader = readerNav.querySelector('#back-to-notes-from-reader'); 
        const darkModeToggle = readerNav.querySelector('#dark-mode-toggle-switch'); 
        const goToLobbyFromWelcome = welcomeNav.querySelector('#go-to-lobby-from-welcome'); 
        const backToLobbyFromTests = testsNav.querySelector('#back-to-lobby-from-tests'); 
        const backToTestsFromFormat = formatNav.querySelector('#back-to-tests-from-format'); 
        // --- End Nav Bar References ---

        const timeLeftDisplay = document.getElementById('time-left');
        const currentQuestionNumberDisplay = document.getElementById('current-question-number');
        const totalQuestionsDisplay = document.getElementById('total-questions-display');

        const finalScorePercentageDisplay = document.getElementById('final-score-percentage');
        const correctAnswersCountDisplay = document.getElementById('correct-answers-count');
        const totalQuestionsResultsDisplay = document.getElementById('total-questions-results');
        const timeTakenResultsDisplay = document.getElementById('time-taken-results');

        const performanceDetailsContainer = document.getElementById('performance-details-container');
        const performanceSubtitle = document.getElementById('performance-subtitle'); 
        const resultsSubtitle = document.getElementById('results-subtitle'); 
        
        const formatScreen = document.getElementById('format-screen');
        const formatCards = document.querySelectorAll('.format-card-button');

        const typewriterOutput = document.getElementById('typewriter-output');

        // State variables for Reader navigation
        let lastScreenBeforeReader = null;


        // --- Screen Navigation System ---
        const allScreens = [
            { element: welcomeScreen, name: 'welcome', nav: welcomeNav }, 
            { element: lobbyScreen, name: 'lobby', nav: lobbyNav },       
            { element: notesScreen, name: 'notes', nav: notesNav },
            { element: decksScreen, name: 'decks', nav: decksNav },   
            { element: miscScreen, name: 'misc', nav: miscNav }, 
            { element: readerScreen, name: 'reader', nav: readerNav },     
            { element: testsScreen, name: 'tests', nav: testsNav },       
            { element: formatScreen, name: 'format', nav: formatNav }, 
            { element: quizScreen, name: 'quiz', nav: quizNav }, 
            { element: resultsScreen, name: 'results', nav: resultsNav }, 
            { element: performanceScreen, name: 'performance', nav: performanceNav }
        ];
        // List of all nav content blocks
        const allNavContents = [welcomeNav, lobbyNav, notesNav, decksNav, miscNav, readerNav, testsNav, formatNav, quizNav, resultsNav, performanceNav]; 
        let currentPage = welcomeScreen;

        /**
         * Central navigation function with transitions and dynamic nav bar.
         * @param {HTMLElement} screenToShow The screen element to transition to.
         * @param {string} direction 'forward' (slide right) or 'backward' (slide left).
         */
        function navigateTo(screenToShow, direction = 'forward') {
            const oldPage = currentPage;
            const newPage = screenToShow;
            
            // Find the screen config object
            const newScreenConfig = allScreens.find(s => s.element === newPage);

            // 1. Handle Nav Bar Visibility
            bottomNavBar.classList.remove('hidden');
            
            // --- Handle Dark Mode state ---
            // Automatically remove dark mode if we navigate away from the reader screen
            if (newPage !== readerScreen) {
                readerScreen.classList.remove('dark-mode');
                bottomNavBar.classList.remove('dark-mode-nav');
                // Reset toggle
                if (darkModeToggle) darkModeToggle.checked = false;
            }
            // --- End Dark Mode Handle ---

            // 2. Handle Nav Content Visibility
            allNavContents.forEach(nav => nav.classList.add('hidden'));
            if (newScreenConfig && newScreenConfig.nav) {
                newScreenConfig.nav.classList.remove('hidden');
            }

            // 3. Handle Screen Transitions
            if (direction === 'forward') {
                newPage.classList.remove('left', 'current');
                newPage.classList.add('right');
            } else {
                newPage.classList.remove('right', 'current');
                newPage.classList.add('left');
            }
            
            newPage.classList.remove('hidden'); // Make it visible for transition
            
            // Force reflow
            void newPage.offsetWidth; 

            if (direction === 'forward') {
                oldPage.classList.remove('current');
                oldPage.classList.add('left');
                newPage.classList.remove('right');
                newPage.classList.add('current');
            } else { // backward
                oldPage.classList.remove('current');
                oldPage.classList.add('right');
                newPage.classList.remove('left');
                newPage.classList.add('current');
            }

            // 4. Update tracker
            currentPage = newPage;
        }
        // --- End Screen Navigation System ---


        // Quiz Variables
        let allQuestionsForCategory = []; 
        let currentQuestions = []; 
        let currentQuestionIndex = 0;
        let score = 0;
        let timerInterval;
        let quizDurationSeconds; 
        let timeLeft; 
        let quizStartTime;
        let selectedQuizCategory = null; 
        let selectedQuizDisplayName = ""; 
        let selectedOption = null; 
        let quizResultsDetails = [];
        let isUnlimitedMode = false;

        // --- Typewriter Loop Logic ---
        const TYPE_TEXT = "Challenge\nYourself\nToday!";
        let charIndex = 0;
        let isDeleting = false;
        let isPaused = false;
        let delay = 100; 

        function typeWriterEffect() {
            if (isPaused) {
                setTimeout(typeWriterEffect, 500);
                return;
            }
            const currentText = TYPE_TEXT;
            if (!isDeleting) {
                if (charIndex < currentText.length) {
                    typewriterOutput.textContent += currentText.charAt(charIndex);
                    charIndex++;
                    delay = currentText.charAt(charIndex - 1) === '\n' ? 500 : 100;
                } else {
                    isPaused = true;
                    setTimeout(() => {
                        isPaused = false;
                        isDeleting = true;
                    }, 2000); 
                }
            } else {
                if (charIndex > 0) {
                    typewriterOutput.textContent = currentText.substring(0, charIndex - 1);
                    charIndex--;
                    delay = 50; 
                } else {
                    isDeleting = false;
                    setTimeout(() => {
                        typeWriterEffect(); 
                    }, 500); 
                    return; 
                }
            }
            setTimeout(typeWriterEffect, delay);
        }
        // --- End Typewriter Loop Logic ---

        // --- Notes Parser (uses 'marked.js' library) ---
        function parseNotesToHTML(text) {
            if (!text) return '<p>No content found.</p>';
            
            try {
                // Set options for compatibility
                marked.setOptions({
                    gfm: true, // Enable GitHub Flavored Markdown
                    breaks: true, // Convert single line breaks to <br>
                    mangle: false, // Prevent mangling of email addresses
                    headerIds: false // Don't add IDs to headers
                });
                return marked.parse(text);
            } catch (error) {
                console.error("Markdown parsing error:", error);
                return '<p class="text-red-600">Error: Could not parse notes.</p>';
            }
        }
        // --- End Notes Parser ---


        // Utility function to show custom message box
        function showMessageBox(title, message, callback) {
            const messageBox = document.getElementById('message-box');
            const messageTitle = document.getElementById('message-title');
            const messageContent = document.getElementById('message-content');
            const messageOkButton = document.getElementById('message-ok-button');

            messageTitle.textContent = title;
            messageContent.textContent = message;
            messageBox.classList.remove('hidden');
            messageOkButton.onclick = () => {
                messageBox.classList.add('hidden');
                if (callback) callback();
            };
        }

        // Function to shuffle an array
        function shuffleArray(array) {
            let newArray = [...array]; 
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
            // Function to handle quiz category selection
        function selectQuizCategory(categoryKey) {
            formatCards.forEach(card => {
                card.dataset.category = categoryKey;
            });
            
            selectedQuizCategory = categoryKey;
            navigateTo(formatScreen, 'forward');
        }

        // Function to handle quiz format selection
        async function selectQuizFormat(event) {
            const card = event.currentTarget;
            
            const categoryKey = card.dataset.category;
            if (!categoryKey) {
                showMessageBox("Error", "Quiz category was not selected. Please return to Tests.", () => {
                    navigateTo(testsScreen, 'backward');
                });
                return;
            }
            
            selectedQuizCategory = categoryKey; 
            
            const numQuestions = card.dataset.questions;
            const timeMinutes = card.dataset.time;
            
            isUnlimitedMode = (numQuestions === 'unlimited' || timeMinutes === 'unlimited');
            
            showMessageBox("Loading Quiz", "Preparing your questions...", null);
            
            try {
                // Call JSON fetch function
                await fetchQuestionsFromJson();

                let questionsToLoad;
                if (isUnlimitedMode) {
                    questionsToLoad = allQuestionsForCategory.length;
                    quizDurationSeconds = null; 
                } else {
                    questionsToLoad = Math.min(parseInt(numQuestions, 10), allQuestionsForCategory.length);
                    quizDurationSeconds = parseInt(timeMinutes, 10) * 60;
                }

                if (allQuestionsForCategory.length === 0) {
                    throw new Error("No questions were found for this category.");
                }
                
                currentQuestions = shuffleArray(allQuestionsForCategory).slice(0, questionsToLoad);
                currentQuestionIndex = 0;
                score = 0;
                quizResultsDetails = [];
                
                document.getElementById('message-box').classList.add('hidden');
                startQuiz();

            } catch (error) {
                console.error("Error preparing quiz:", error);
                showMessageBox("Error", `Failed to start quiz: ${error.message}`);
            }
        }
        
        /**
         * Fetches questions from local JSON files in the /data directory.
         */
        async function fetchQuestionsFromJson() {
            if (!selectedQuizCategory) {
                throw new Error("No quiz category selected.");
            }

            const categoryFilename = quizCategories[selectedQuizCategory];
            if (!categoryFilename) {
                throw new Error(`Invalid quiz category key: ${selectedQuizCategory}`);
            }
            
            // Build path to the local JSON file
            const jsonPath = `./data/${categoryFilename}.json`;
            
            console.log("Fetching from:", jsonPath);
            
            try {
                const response = await fetch(jsonPath);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - Ensure ${jsonPath} exists`);
                }
                
                allQuestionsForCategory = await response.json();
                console.log(`Fetched ${allQuestionsForCategory.length} questions.`);

                if (!Array.isArray(allQuestionsForCategory)) {
                    throw new Error("Data file is not a valid JSON array.");
                }
                
            } catch (error) {
                console.error("Error fetching local JSON:", error);
                throw new Error("Could not load questions. Please check your internet connection or if the data file exists.");
            }
        }

        // --- Function to generate Table of Contents ---
        function generateTableOfContents(title) {
            readerAnchorOverlay.innerHTML = ''; // Clear previous content
            
            const headers = readerContentContainer.querySelectorAll('h1, h2');
            
            // Document Title
            const docTitle = document.createElement('h3');
            docTitle.textContent = title;
            docTitle.className = 'anchor-section-title';
            readerAnchorOverlay.appendChild(docTitle);
            
            if (headers.length === 0) {
                const noHeadersMsg = document.createElement('p');
                noHeadersMsg.textContent = "No headers found in this document.";
                noHeadersMsg.className = "text-sm text-gray-500 italic mt-2";
                readerAnchorOverlay.appendChild(noHeadersMsg);
                return;
            }

            headers.forEach((header, index) => {
                // Generate ID if missing
                if (!header.id) {
                    header.id = 'header-' + index;
                }

                const link = document.createElement('a');
                link.textContent = header.textContent;
                link.className = 'anchor-link-item';
                
                if (header.tagName === 'H2') {
                    link.classList.add('anchor-link-h2');
                }

                link.addEventListener('click', () => {
                    header.scrollIntoView({ behavior: 'smooth' });
                    // Close overlay
                    readerAnchorOverlay.classList.remove('open');
                });

                readerAnchorOverlay.appendChild(link);
            });
        }

        // --- Function to open Reader Page ---
        async function openReaderPage(noteFile, title, sourceScreen) {
            readerTitle.textContent = title;
            readerContentContainer.innerHTML = '<p class="text-center text-gray-600">Loading content...</p>';
            
            // Reset overlay state
            readerAnchorOverlay.classList.remove('open');
            readerAnchorOverlay.innerHTML = '';
            
            // Save source screen for back navigation
            if (sourceScreen) {
                lastScreenBeforeReader = sourceScreen;
            }

            navigateTo(readerScreen, 'forward');

            const notePath = `./data/${noteFile}`;
            console.log("Fetching notes/decks from:", notePath);

            try {
                const response = await fetch(notePath);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - Ensure ${notePath} exists`);
                }
                const rawNotes = await response.text();
                const notesHTML = parseNotesToHTML(rawNotes);
                readerContentContainer.innerHTML = notesHTML;
                
                // Generate Anchor Links after content is injected
                generateTableOfContents(title);

            } catch (error) {
                console.error("Error fetching content:", error);
                readerContentContainer.innerHTML = `<p class="text-center text-red-600 font-semibold">Error: Could not load content.<br>${error.message}</p>`;
                showMessageBox("Error", `Failed to load content: ${error.message}`);
            }
        }


        // Function to start the quiz
        function startQuiz() {
            navigateTo(quizScreen, 'forward');
            quizStartTime = new Date();

            if (isUnlimitedMode) {
                timeLeftDisplay.textContent = "Untimed";
                totalQuestionsDisplay.textContent = currentQuestions.length;
            } else {
                timeLeft = quizDurationSeconds;
                updateTimerDisplay();
                timerInterval = setInterval(updateTimer, 1000);
                totalQuestionsDisplay.textContent = currentQuestions.length;
            }
            
            loadQuestion();
        }

        // Function to load the current question
        function loadQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                endQuiz();
                return;
            }

            const currentQuestion = currentQuestions[currentQuestionIndex];
            questionText.textContent = currentQuestion.question;
            currentQuestionNumberDisplay.textContent = currentQuestionIndex + 1;
            
            selectedOption = null;
            submitAnswerButton.disabled = true;

            const shuffledOptionKeys = shuffleArray(Object.keys(currentQuestion.options));
            
            optionButtons.forEach((button, index) => {
                const originalKey = shuffledOptionKeys[index];
                const optionText = currentQuestion.options[originalKey];
                const displayLabel = ['A', 'B', 'C', 'D'][index]; 

                button.textContent = `${displayLabel}. ${optionText}`;
                button.dataset.option = originalKey; 

                button.classList.remove('selected', 'correct', 'incorrect');
                button.disabled = false;
            });
        }

        // Function to handle answer submission
        function submitAnswer() {
            if (!selectedOption) return;

            const currentQuestion = currentQuestions[currentQuestionIndex];
            const isCorrect = (selectedOption === currentQuestion.correctAnswer);

            quizResultsDetails.push({
                question: currentQuestion.question,
                selectedOption: currentQuestion.options[selectedOption],
                correctOption: currentQuestion.options[currentQuestion.correctAnswer],
                isCorrect: isCorrect
            });

            if (isCorrect) {
                score++;
            }
            
            optionButtons.forEach(button => {
                button.disabled = true; 
                const buttonOptionKey = button.dataset.option;
                
                if (buttonOptionKey === currentQuestion.correctAnswer) {
                    button.classList.add('correct');
                } else if (button.classList.contains('selected')) {
                    button.classList.add('incorrect');
                }
            });

            setTimeout(() => {
                currentQuestionIndex++;
                loadQuestion();
            }, 1500);
        }

        // Function to update the timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timeLeftDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Function to update the timer every second
        function updateTimer() {
            timeLeft--;
            if (timeLeft < 0) {
                endQuiz(true); 
            } else {
                updateTimerDisplay();
            }
        }

        // Function to end the quiz
        function endQuiz(timedOut = false) {
            clearInterval(timerInterval);
            
            const timeTaken = Math.floor((new Date() - quizStartTime) / 1000);
            const minutes = Math.floor(timeTaken / 60);
            const seconds = timeTaken % 60;
            
            let totalQuestionsAnswered = currentQuestions.length;
            if (timedOut) {
                totalQuestionsAnswered = currentQuestionIndex; 
            }

            let percentageScore = 0;
            if (totalQuestionsAnswered > 0) {
                percentageScore = ((score / totalQuestionsAnswered) * 100).toFixed(0);
            }

            finalScorePercentageDisplay.textContent = percentageScore;
            correctAnswersCountDisplay.textContent = score;
            totalQuestionsResultsDisplay.textContent = totalQuestionsAnswered;
            resultsSubtitle.textContent = selectedQuizDisplayName; 
            
            if (isUnlimitedMode) {
                 timeTakenResultsDisplay.textContent = `Time taken: ${minutes}m ${seconds}s`;
            } else if (timedOut) {
                timeTakenResultsDisplay.textContent = `Time ran out! You spent ${minutes}m ${seconds}s on the quiz.`;
            } else {
                timeTakenResultsDisplay.textContent = `and finished in ${minutes}m ${seconds}s.`;
            }

            navigateTo(resultsScreen, 'forward');
        }

        /* --- Fullscreen Toggle Logic --- */
        function setupFullscreenToggle() {
            const fullscreenToggleButtons = document.querySelectorAll('.fullscreen-toggle-button');

            // This function will update ALL toggle icons on the page
            function updateAllFullscreenIcons() {
                const allOpenIcons = document.querySelectorAll('.fullscreen-open-icon');
                const allCloseIcons = document.querySelectorAll('.fullscreen-close-icon');
                
                if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) {
                    allOpenIcons.forEach(icon => icon.classList.add('hidden'));
                    allCloseIcons.forEach(icon => icon.classList.remove('hidden'));
                } else {
                    allOpenIcons.forEach(icon => icon.classList.remove('hidden'));
                    allCloseIcons.forEach(icon => icon.classList.add('hidden'));
                }
            }

            function toggleFullscreen() {
                const elem = document.documentElement; // Toggle fullscreen for the whole page

                if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                    // Enter fullscreen
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen();
                    } else if (elem.webkitRequestFullscreen) { /* Safari */
                        elem.webkitRequestFullscreen();
                    } else if (elem.mozRequestFullScreen) { /* Firefox */
                        elem.mozRequestFullScreen();
                    } else if (elem.msRequestFullscreen) { /* IE/Edge */
                        elem.msRequestFullscreen();
                    }
                } else {
                    // Exit fullscreen
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) { /* Safari */
                        document.webkitExitFullscreen();
                    } else if (document.mozCancelFullScreen) { /* Firefox */
                        document.mozCancelFullScreen();
                    } else if (document.msExitFullscreen) { /* IE/Edge */
                        document.msExitFullscreen();
                    }
                }
            }

            // Add click listener to every toggle button
            fullscreenToggleButtons.forEach(button => {
                button.addEventListener('click', toggleFullscreen);
            });

            // Listen for changes in fullscreen state (e.g., user pressing Esc)
            document.addEventListener('fullscreenchange', updateAllFullscreenIcons);
            document.addEventListener('webkitfullscreenchange', updateAllFullscreenIcons);
            document.addEventListener('mozfullscreenchange', updateAllFullscreenIcons);
            document.addEventListener('MSFullscreenChange', updateAllFullscreenIcons);
        }
        /* --- End Fullscreen Toggle Logic --- */

        // Function to show performance breakdown
        function showPerformance() {
            navigateTo(performanceScreen, 'forward');
            performanceSubtitle.textContent = selectedQuizDisplayName; 
            performanceDetailsContainer.innerHTML = ''; 

            if (quizResultsDetails.length === 0) {
                performanceDetailsContainer.innerHTML = '<p class="text-center text-gray-600">No questions were answered in this quiz session.</p>';
                return;
            }

            quizResultsDetails.forEach((result, index) => {
                let feedbackHTML = '';
                if (result.isCorrect) {
                    feedbackHTML = `<p class="performance-answer correct-feedback">Your answer: ${result.selectedOption} (Correct)</p>`;
                } else {
                    feedbackHTML = `
                        <p class="performance-answer incorrect-feedback">Your answer: ${result.selectedOption} (Incorrect)</p>
                        <p class="performance-correct-answer">Correct answer: ${result.correctOption}</p>
                    `;
                }

                const itemHTML = `
                    <div class="performance-item">
                        <p class="performance-question">${index + 1}. ${result.question}</p>
                        ${feedbackHTML}
                    </div>
                `;
                performanceDetailsContainer.innerHTML += itemHTML;
            });
        }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            typeWriterEffect();
            setupFullscreenToggle(); 
            
            // Unlock the buttons immediately since we don't need to wait for auth
            quizCategoryButtons.forEach(button => button.disabled = false);
            loadingMessage.classList.add('hidden');
            
            // Initial screen state setup
            allScreens.forEach(s => {
                if (s.element !== welcomeScreen) {
                    s.element.classList.add('right'); // All start off-screen right
                }
            });
            welcomeScreen.classList.add('current');
            currentPage = welcomeScreen;


            /* --- Manually set initial nav bar state --- */
            bottomNavBar.classList.remove('hidden'); 
            allNavContents.forEach(nav => nav.classList.add('hidden'));
            welcomeNav.classList.remove('hidden'); 
            /* --- End Initial Nav Setup --- */


            /* --- Welcome Screen --- */
            goToLobbyFromWelcome.addEventListener('click', () => {
                navigateTo(lobbyScreen, 'forward');
            });

            /* --- Lobby Screen --- */
            goToNotesButton.addEventListener('click', () => {
                navigateTo(notesScreen, 'forward');
            });

            goToDecksButton.addEventListener('click', () => {
                navigateTo(decksScreen, 'forward');
            });

            goToTestsButton.addEventListener('click', () => {
                navigateTo(testsScreen, 'forward');
            });

            // Misc button listener
            if (goToMiscButton) {
                goToMiscButton.addEventListener('click', () => {
                    navigateTo(miscScreen, 'forward');
                });
            }

            backToWelcomeFromLobby.addEventListener('click', () => {
                navigateTo(welcomeScreen, 'backward');
            });

            /* --- Notes Screen --- */
            backToLobbyFromNotes.addEventListener('click', () => {
                navigateTo(lobbyScreen, 'backward');
            });

            notesCategoryButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    const { noteFile, noteTitle } = event.currentTarget.dataset;
                    if (noteFile && noteTitle) {
                        openReaderPage(noteFile, noteTitle, notesScreen);
                    } else {
                        showMessageBox("Notice", "Notes for this section are not yet available.");
                    }
                });
            });

            /* --- Decks Screen --- */
            backToLobbyFromDecks.addEventListener('click', () => {
                navigateTo(lobbyScreen, 'backward');
            });

            decksCategoryButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    const { noteFile, noteTitle } = event.currentTarget.dataset; 
                    if (noteFile && noteTitle) {
                        openReaderPage(noteFile, noteTitle, decksScreen);
                    } else {
                        showMessageBox("Notice", "Deck for this section is not yet available.");
                    }
                });
            });

            /* --- Misc Screen --- */
            backToLobbyFromMisc.addEventListener('click', () => {
                navigateTo(lobbyScreen, 'backward');
            });

            miscCategoryButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    const { noteFile, noteTitle } = event.currentTarget.dataset; 
                    if (noteFile && noteTitle) {
                        openReaderPage(noteFile, noteTitle, miscScreen);
                    } else {
                        showMessageBox("Notice", "Content for this item is not yet available.");
                    }
                });
            });

            /* --- Reader Screen --- */
            backToNotesFromReader.addEventListener('click', () => {
                // Return to the screen that invoked the reader
                if (lastScreenBeforeReader) {
                    navigateTo(lastScreenBeforeReader, 'backward');
                } else {
                    navigateTo(notesScreen, 'backward'); // Default fallback
                }
            });

            // Reader Hamburger Button Toggle
            readerHamburgerButton.addEventListener('click', () => {
                readerAnchorOverlay.classList.toggle('open');
            });

            // Close Reader Overlay when clicking content area
            readerContentContainer.addEventListener('click', () => {
                if (readerAnchorOverlay.classList.contains('open')) {
                    readerAnchorOverlay.classList.remove('open');
                }
            });
            
            /* --- Dark Mode Toggle --- */ 
            darkModeToggle.addEventListener('change', () => { 
                readerScreen.classList.toggle('dark-mode');
                bottomNavBar.classList.toggle('dark-mode-nav');
            });


            /* --- Tests Screen --- */
            quizCategoryButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    const categoryKey = event.currentTarget.dataset.quizCategory;
                    selectedQuizDisplayName = event.currentTarget.querySelector('.card-title').textContent.trim();
                    selectQuizCategory(categoryKey);
                });
            });
            
            backToLobbyFromTests.addEventListener('click', () => {
                navigateTo(lobbyScreen, 'backward');
            });

            /* --- Format Screen --- */
            formatCards.forEach(card => {
                card.addEventListener('click', selectQuizFormat);
            });

            backToTestsFromFormat.addEventListener('click', () => {
                navigateTo(testsScreen, 'backward');
            });

            /* --- Quiz Screen --- */
            optionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    optionButtons.forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    selectedOption = button.dataset.option;
                    submitAnswerButton.disabled = false;
                });
            });

            submitAnswerButton.addEventListener('click', submitAnswer);
            
            quitQuizButton.addEventListener('click', () => {
                showMessageBox("Quit", "Are you sure you want to end the quiz?", () => {
                    endQuiz(false); 
                });
            });

            /* --- Results Screen --- */
            returnToTestsFromResultsButton.addEventListener('click', () => {
                navigateTo(testsScreen, 'backward');
            });
            
            seePerformanceButton.addEventListener('click', () => {
                showPerformance();
            });

            /* --- Performance Screen --- */
            returnToTestsFromPerformanceButton.addEventListener('click', () => {
                navigateTo(testsScreen, 'backward');
            });
        });

    </script>
</body>
</html>


