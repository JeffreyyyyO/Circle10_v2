<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circle10 Quiz App</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter & Sora & Space Grotesk -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&family=Sora:wght@300;400;600;900&family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* NEW: Force body and html to 100% width and prevent horizontal scroll */
        html, body {
            width: 100%;
            overflow-x: hidden;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #333333; /* Plain dark gray background color */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Ensure it takes full viewport height */
            margin: 0;
            padding: 0; /* Removed body padding */
            box-sizing: border-box; /* MODIFIED: Added box-sizing */
        }
        
        /* UPDATED: Container is now a flex-col layout for the main content and nav bar */
        .quiz-container {
            width: 100%;       /* MODIFIED: Changed from 100vw to 100% */
            min-height: 100vh;  /* Fill the viewport height */
            max-width: 500px;   /* A good upper limit for a "phone" app UI */
            
            background-color: #d0d0d0;
            border-radius: 0; 
            
            /* UPDATED: Container is now a flex column with 0 padding */
            display: flex;
            flex-direction: column;
            padding: 0; /* Padding is now on the screens and nav bar */
            
            transition: all 0.3s ease-in-out;
            box-sizing: border-box;
            overflow: hidden; /* Hide overflow */
        }
        
        /* NEW: This area holds all the screens */
        #main-content-area {
            flex-grow: 1; /* Takes up all available space above the nav bar */
            position: relative; /* For the absolute positioned screens */
            overflow: hidden; /* For the transition */
        }

        /* UPDATED: Screens are now inside the main-content-area */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* MODIFIED: Removed bottom padding */
            padding: 5vw 2vw 0 2vw; 
            box-sizing: border-box;
            background-color: #d0d0d0; /* Match container color */
            transition: transform 0.3s ease-out;
            z-index: 10;
            
            /* Ensure screens are flex-col to fill height */
            display: flex;
            flex-direction: column;
        }

        /* NEW: Horizontal padding override for lobby/format screens */
        #lobby-screen, #format-screen {
            padding-left: 0;
            padding-right: 0;
        }

        /* Screen transition states */
        .screen.current {
            transform: translateX(0);
        }
        .screen.left {
            transform: translateX(-100%);
        }
        .screen.right {
            transform: translateX(100%);
        }
        
        /* UPDATED: Quiz Screen Layout */
        #quiz-screen {
            /* flex-col is now default on .screen */
        }
        
        #quiz-main-content {
            flex-grow: 1; /* Pushes buttons to the bottom */
            overflow-y: auto; /* Allows questions/options to scroll if needed */
        }
        
        /* REMOVED: #quiz-button-container is replaced by #bottom-nav-bar */


        .option-button {
            display: block;
            width: 100%;
            padding: 15px 20px;
            margin-bottom: 10px;
            background-color: #e2e8f0; /* Light gray */
            color: #334155; /* Dark gray text */
            border: 2px solid #cbd5e1; /* Lighter border */
            border-radius: 12px;
            text-align: left;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            box-sizing: border-box;
            font-family: 'Sora', sans-serif; /* Sora font for options */
            font-weight: 400;
        }
        .option-button:hover {
            background-color: #d1d9e2;
            border-color: #94a3b8;
        }
        .option-button.selected {
            background-color: #a7d9f8; /* Light blue for selected */
            border-color: #38bdf8; /* Blue border for selected */
            color: #0c4a6e; /* Darker blue text */
        }
        .option-button.correct {
            background-color: #d1fae5; /* Light green for correct */
            border-color: #34d399; /* Green border for correct */
            color: #065f46; /* Dark green text */
        }
        .option-button.incorrect {
            background-color: #fee2e2; /* Light red for incorrect */
            border-color: #ef4444; /* Red border for incorrect */
            color: #991b1b; /* Dark red text */
        }
        
        /* --- Font Application --- */
        #question-text {
            font-family: 'Sora', sans-serif;
            font-weight: 600;
        }
        
        #lobby-screen h1,
        #format-screen h1,
        #results-screen h2,
        #performance-screen h2,
        #message-title {
            font-family: 'Sora', sans-serif;
        }

        .score-indigo-text {
            color: #4f46e5; 
        }
        
        .submit-button {
            background-color: #3b82f6; /* Blue */
            color: white;
            padding: 14px 25px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 300; /* Adjusted font weight */
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
        }
        .submit-button:hover {
            background-color: #2563eb; /* Darker blue on hover */
        }
        .submit-button:disabled {
            background-color: #93c5fd; /* Lighter blue when disabled */
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .quit-button {
            background-color: #ef4444; /* Red */
            color: white;
            padding: 14px 25px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 300; /* Adjusted font weight */
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
        }
        .quit-button:hover {
            background-color: #dc2626; /* Darker red on hover */
        }
        
        /* UPDATED: .lobby-buttons no longer needs bottom padding */
        .lobby-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 20px;
            margin-top: 20px;
            overflow-y: auto; /* Allow scrolling if cards overflow */
            flex-grow: 1; /* Make it fill the space */
            
            /* --- SCROLLBAR HIDING --- */
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
            
            /* MODIFIED: Add padding, so content isn't edge-to-edge */
            padding-left: 2vw;
            padding-right: 2vw;
            box-sizing: border-box;

            /* NEW: Added padding at the bottom of the scroll content */
            padding-bottom: 5vw;
        }
        .lobby-buttons::-webkit-scrollbar {
            display: none; /* Chrome, Safari */
        }
        /* --- END SCROLLBAR HIDING --- */
        
        /* --- REFACTORED: Base Card Style --- */
        .quiz-card-base {
            aspect-ratio: 1 / 1; 
            border-radius: 16px;
            font-weight: 300;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            text-align: center;
            width: 100%;
        }

        /* --- Indigo Card Color --- */
        .quiz-card-indigo {
            background-color: #4f46e5; /* Indigo/Purple */
            color: white;
        }
        .quiz-card-indigo:hover {
            background-color: #4338ca; /* Darker indigo on hover */
        }

        /* --- NEW: Orange Card Color --- */
        .quiz-card-orange {
            background-color: #CC5500; /* Burnt Orange */
            color: white;
        }
        .quiz-card-orange:hover {
            background-color: #aa4400; /* Darker Orange */
        }
        
        .format-card-button {
            aspect-ratio: 1 / 1; 
            background-color: #800000; /* Maroon color */
            color: white;
            border-radius: 16px;
            font-weight: 300;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            text-align: center;
            width: 100%;
        }
        .format-card-button:hover {
            background-color: #660000; /* Darker maroon on hover */
        }
        
        /* Surfing Card Specific Styles */
        .surfing-card {
            background-color: #7bace0;
            color: #0d2036;
            grid-column: 1 / span 2; /* Span across 2 columns */
            aspect-ratio: 2 / 0.5; /* Match width of 2 cards, half height of 1 */
            padding: 10px;
        }
        .surfing-card:hover {
            background-color: #6a95c0; /* Darker blue for hover */
        }


        .card-subtitle {
            font-size: 0.875rem; /* text-sm */
            opacity: 0.8;
            font-weight: 400;
        }
        .card-title {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600;
            margin-bottom: 4px; /* Added bottom margin */
            line-height: 1; /* Added line-height */
        }
        .performance-item {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: left;
        }
        .performance-question {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
        }
        .performance-answer {
            margin-bottom: 5px;
            color: #475569;
        }
        .performance-answer.correct-feedback {
            color: #065f46; /* Dark green */
            font-weight: 500;
        }
        .performance-answer.incorrect-feedback {
            color: #991b1b; /* Dark red */
            font-weight: 500;
        }
        .performance-correct-answer {
            color: #0f766e; /* Teal */
            font-weight: 500;
        }
        
        /* NEW: Added padding to performance container */
        #performance-details-container {
            padding-bottom: 5vw;
        }
        
        /* UPDATED: Bottom Navigation Bar Styling */
        #bottom-nav-bar {
            flex-shrink: 0; /* Prevent shrinking */
            height: auto; /* Auto height to fit content */
            width: 100%;
            background-color: #d0d0d0; /* Match container background */
            border-top: 1px solid #b4b4b4;
            /* MODIFIED: Reduced vertical padding */
            padding: 2vw 2vw; /* 2vw top/bottom, 3vw left/right */
            box-sizing: border-box;
            z-index: 20;
        }
        
        /* NEW: Class for nav content blocks */
        .nav-content {
            width: 100%;
            display: flex;
            align-items: center;
        }

        .back-icon-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #6b7280; /* Gray-500 */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            border: none;
            cursor: pointer;
            z-index: 10; 
        }
        .back-icon-button:hover {
            background-color: #4b5563; /* Gray-600 */
        }
        
        #typewriter-output {
            font-family: 'Space Grotesk', monospace;
            font-size: 3.3rem; 
            min-height: 8rem; 
            white-space: pre-wrap;
            overflow: hidden;
            border-right: none; 
            line-height: 1.1; 
            display: inline-block;
            transition: none; 
            padding-right: 2px;
        }
        
        .welcome-start-button {
            background-color: #4f46e5; /* Indigo */
            color: white;
            padding: 16px 30px; 
            border-radius: 12px;
            font-size: 1.5rem; 
            font-weight: 600; 
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
            font-family: 'Sora', sans-serif; 
            width: 66.6666%; /* w-2/3 equivalent */
        }
        .welcome-start-button:hover {
            background-color: #4338ca; 
        }
        
    </style>
</head>
<body class="antialiased">
    <!-- Main container is now fluid -->
    <div id="quiz-app" class="quiz-container"> 

        <!-- NEW: Main Content Area (for screens) -->
        <div id="main-content-area" class="flex-grow relative overflow-hidden">

            <!-- Welcome Screen (No changes to its own content) -->
            <div id="welcome-screen" class="screen current justify-between items-center pt-20 pb-10">
                <div class="text-center">
                    <h1 class="text-7xl text-gray-800" style="font-family: 'Sora', sans-serif;">
                        <span class="font-light" style="font-weight: 300;">Circle</span><span class="font-black italic" style="font-weight: 900;">10</span>
                    </h1>
                    <p class="text-sm text-gray-600 mb-1">AltSchool Africa &bull; Karatu 2025 &bull; Cybersecurity</p>
                    <p class="text-sm text-gray-400 mb-8">&bull; published by Jeffrey O &bull;</p>

                    <div class="h-auto text-gray-500 font-bold mb-10">
                        <span id="typewriter-output"></span>
                    </div>
                </div>
                
                <button id="continue-button" class="welcome-start-button">Start</button>
            </div>

            <!-- Lobby Screen (Back button removed) -->
            <div id="lobby-screen" class="screen right text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 flex-shrink-0 px-[2vw]">LOBBY</h1>
                <p class="text-lg text-gray-700 mb-8 flex-shrink-0 px-[2vw]">Pick a Section</p>
                
                <!-- MODIFIED: Removed inline style from lobby-buttons -->
                <div class="lobby-buttons"> <!-- This div will now scroll -->
                    <!-- Row 1 (Indigo) -->
                    <button class="quiz-card-base quiz-card-indigo" data-quiz-category="Fundamentals_of_Network_Security">
                        <span class="card-subtitle">CYS 520 &bull; Week 1</span>
                        <span class="card-title">Fundamentals of Network Security</span>
                    </button>
                    <button class="quiz-card-base quiz-card-indigo" data-quiz-category="Network_Security_Devices_and_Technologies">
                        <span class="card-subtitle">CYS 520 &bull; Week 2</span>
                        <span class="card-title">Network Security Devices and Technologies</span>
                    </button>
                    <!-- Row 2 (Indigo) -->
                    <button class="quiz-card-base quiz-card-indigo" data-quiz-category="Introduction_to_Cryptography">
                        <span class="card-subtitle">CYS 520 &bull; Week 3</span>
                        <span class="card-title">Introduction to Cryptography</span>
                    </button>
                    <button class="quiz-card-base quiz-card-indigo" data-quiz-category="Cryptographic_Applications">
                        <span class="card-subtitle">CYS 520 &bull; Week 4</span>
                        <span class="card-title">Cryptographic Applications</span>
                    </button>
                    <!-- Row 3 (Orange) -->
                    <button class="quiz-card-base quiz-card-orange" data-quiz-category="Endpoint_Security">
                        <span class="card-subtitle">CYS 525 &bull; Week 1</span>
                        <span class="card-title">Endpoint Security</span>
                    </button>
                    <button class="quiz-card-base quiz-card-orange" data-quiz-category="Advanced_Endpoint_Security">
                        <span class="card-subtitle">CYS 525 &bull; Week 2</span>
                        <span class="card-title">Advanced Endpoint Security</span>
                    </button>
                    <!-- Row 4 (Orange) -->
                    <button class="quiz-card-base quiz-card-orange" data-quiz-category="Standards_Regulations_and_Data_Privacy">
                        <span class="card-subtitle">CYS 525 &bull; Week 3</span>
                        <span class="card-title">Standards, Regulations and Data Privacy</span>
                    </button>
                    <button class="quiz-card-base quiz-card-orange" data-quiz-category="Data_Privacy_and_Professional_Issues">
                        <span class="card-subtitle">CYS 525 &bull; Week 4</span>
                        <span class="card-title">Data Privacy and Professional Issues</span>
                    </button>

                    <p id="loading-message" class="text-sm text-gray-600 col-span-full hidden">Loading quiz data...</p>
                </div>
                
                <!-- Back button removed from here -->
            </div>

            <!-- Format Screen (Back button removed) -->
            <div id="format-screen" class="screen right text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 flex-shrink-0 px-[2vw]">FORMAT</h1>
                <p class="text-lg text-gray-700 mb-8 flex-shrink-0 px-[2vw]">Pick a Format</p>
                
                <!-- MODIFIED: Removed inline style from lobby-buttons -->
                <div class="lobby-buttons"> <!-- This div will now scroll -->
                    <!-- Row 1 -->
                    <button class="format-card-button" data-questions="5" data-time="2">
                        <span class="card-subtitle">5 questions &bull; 2 minutes</span>
                        <span class="card-title">Mini Quiz</span>
                    </button>
                    <button class="format-card-button" data-questions="10" data-time="5">
                        <span class="card-subtitle">10 questions &bull; 5 minutes</span>
                        <span class="card-title">Pop Quiz</span>
                    </button>
                    <!-- Row 2 -->
                    <button class="format-card-button" data-questions="15" data-time="10">
                        <span class="card-subtitle">15 questions &bull; 10 minutes</span>
                        <span class="card-title">Test</span>
                    </button>
                    <button class="format-card-button" data-questions="40" data-time="30">
                        <span class="card-subtitle">40 questions &bull; 30 minutes</span>
                        <span class="card-title">Exam</span>
                    </button>
                    <!-- Row 3 - Surfing Card -->
                    <button class="format-card-button surfing-card" data-questions="unlimited" data-time="unlimited">
                        <span class="card-subtitle">All the questions &bull; All the time</span>
                        <span class="card-title">Surfing!</span>
                    </button>
                </div>
                
                <!-- Back button removed from here -->
            </div>
            
            <!-- Quiz Screen (Button container removed) -->
            <div id="quiz-screen" class="screen right">
                <div id="quiz-main-content">
                    <div class="flex justify-between items-center mb-6">
                        <div class="text-lg font-semibold text-gray-600">Question <span id="current-question-number">1</span> / <span id="total-questions-display"></span></div>
                        <div classV="text-2xl font-bold text-red-600" id="time-left">00:00</div>
                    </div>
                    <h2 id="question-text" class="text-2xl font-semibold text-gray-800 mb-6"></h2>
                    
                    <div id="options-container" class="grid gap-4">
                        <button class="option-button"></button>
                        <button class="option-button"></button>
                        <button class="option-button"></button>
                        <button class="option-button"></button>
                    </div>
                </div>
                
                <!-- Button container removed from here -->
            </div>

            <!-- Results Screen (Button container removed) -->
            <div id="results-screen" class="screen right text-center justify-between">
                <div class="flex-grow flex flex-col justify-center items-center">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Done!</h2>
                    
                    <p class="text-8xl font-bold mb-4 score-indigo-text" style="font-family: 'Sora', sans-serif;">
                        <span id="final-score-percentage"></span>%
                    </p>

                    <p class="text-lg text-gray-600 mb-2">You got <span id="correct-answers-count" class="font-bold score-indigo-text"></span> out of <span id="total-questions-results" class="font-bold score-indigo-text"></span> right!</p>
                    <p class="text-lg text-gray-600 mb-6" id="time-taken-results"></p>
                </div>

                <!-- Button container removed from here -->
            </div>

            <!-- Performance Screen (Button removed) -->
            <div id="performance-screen" class="screen right">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center flex-shrink-0">Your Performance</h2>
                <div id="performance-details-container" class="mt-4 flex-grow" style="overflow-y: auto; -ms-overflow-style: none; scrollbar-width: none;">
                    <!-- Performance items will be injected here -->
                </div>
                
                <!-- Button removed from here -->
            </div>

        </div> <!-- End #main-content-area -->


        <!-- NEW: Persistent Bottom Navigation Bar -->
        <div id="bottom-nav-bar" class="hidden"> <!-- Hidden by default, shown by navigateTo -->

            <!-- Lobby Nav Content -->
            <div id="lobby-nav" class="nav-content hidden w-full justify-start">
                <button id="back-to-welcome-from-lobby" class="back-icon-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M7.72 12.53a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 1 1 1.06 1.06L9.31 12l6.97 6.97a.75.75 0 1 1-1.06 1.06l-7.5-7.5Z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <!-- Format Nav Content -->
            <div id="format-nav" class="nav-content hidden w-full justify-start">
                <button id="back-to-lobby-from-format" class="back-icon-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M7.72 12.53a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 1 1 1.06 1.06L9.31 12l6.97 6.97a.75.75 0 1 1-1.06 1.06l-7.5-7.5Z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <!-- Quiz Nav Content -->
            <div id="quiz-nav" class="nav-content hidden w-full">
                <div class="flex flex-col sm:flex-row gap-4 w-full">
                    <button id="quit-quiz-button" class="quit-button w-full sm:w-1/4">Quit</button>
                    <button id="submit-answer-button" class="submit-button w-full sm:w-3/4" disabled>Submit</button>
                </div>
            </div>

            <!-- Results Nav Content -->
            <div id="results-nav" class="nav-content hidden w-full">
                <div class="flex flex-row gap-4 w-full">
                    <button id="see-performance-button" class="quiz-card-base quiz-card-indigo w-1/2" style="aspect-ratio: 2 / 1;">
                        <span class="card-title">Performance</span>
                        <span class="card-subtitle">See how you did!</span>
                    </button>
                    <button id="return-to-lobby-from-results-button" class="quiz-card-base quiz-card-indigo w-1/2" style="aspect-ratio: 2 / 1;">
                        <span class="card-title">Lobby</span>
                        <span class="card-subtitle">Return to the lobby!</span>
                    </button>
                </div>
            </div>

            <!-- Performance Nav Content -->
            <div id="performance-nav" class="nav-content hidden w-full">
                <button id="return-to-lobby-from-performance-button" class="quiz-card-base quiz-card-indigo w-full py-4 text-lg font-semibold" style="aspect-ratio: unset; height: auto;">
                    Return to Lobby
                </button>
            </div>

        </div> <!-- End #bottom-nav-bar -->


        <!-- Message Box (Stays at root) -->
        <div id="message-box" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full text-center">
                <h3 id="message-title" class="text-2xl font-bold text-gray-800 mb-4"></h3>
                <p id="message-content" class="text-gray-700 mb-6"></p>
                <button id="message-ok-button" class="submit-button w-full">OK</button>
            </div>
        </div>
    </div> <!-- End #quiz-app -->

    <script type="module">
        // --- QUIZ CATEGORY SETUP ---
        const quizCategories = {
            "Fundamentals_of_Network_Security": "Fundamentals_of_Network_Security",
            "Network_Security_Devices_and_Technologies": "Network_Security_Devices_and_Technologies",
            "Introduction_to_Cryptography": "Introduction_to_Cryptography",
            "Cryptographic_Applications": "Cryptographic_Applications",
            "Endpoint_Security": "Endpoint_Security",
            "Advanced_Endpoint_Security": "Advanced_Endpoint_Security",
            "Standards_Regulations_and_Data_Privacy": "Standards_Regulations_and_Data_Privacy",
            "Data_Privacy_and_Professional_Issues": "Data_Privacy_and_Professional_Issues"
        };
        
        // DOM Elements
        const welcomeScreen = document.getElementById('welcome-screen');
        const continueButton = document.getElementById('continue-button');
        const lobbyScreen = document.getElementById('lobby-screen');
        const loadingMessage = document.getElementById('loading-message');
        const quizCategoryButtons = document.querySelectorAll('#lobby-screen .quiz-card-base'); 

        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const performanceScreen = document.getElementById('performance-screen');
        
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const optionButtons = optionsContainer.querySelectorAll('.option-button'); 
        
        // --- UPDATED: Nav Bar and Content References ---
        const bottomNavBar = document.getElementById('bottom-nav-bar');
        const lobbyNav = document.getElementById('lobby-nav');
        const formatNav = document.getElementById('format-nav');
        const quizNav = document.getElementById('quiz-nav');
        const resultsNav = document.getElementById('results-nav');
        const performanceNav = document.getElementById('performance-nav');
        
        // Buttons now referenced from their nav containers
        const submitAnswerButton = quizNav.querySelector('#submit-answer-button');
        const quitQuizButton = quizNav.querySelector('#quit-quiz-button');
        const returnToLobbyFromResultsButton = resultsNav.querySelector('#return-to-lobby-from-results-button');
        const seePerformanceButton = resultsNav.querySelector('#see-performance-button');
        const returnToLobbyFromPerformanceButton = performanceNav.querySelector('#return-to-lobby-from-performance-button');
        const backToWelcomeFromLobby = lobbyNav.querySelector('#back-to-welcome-from-lobby');
        const backToLobbyFromFormat = formatNav.querySelector('#back-to-lobby-from-format');
        // --- End Nav Bar References ---

        const timeLeftDisplay = document.getElementById('time-left');
        const currentQuestionNumberDisplay = document.getElementById('current-question-number');
        const totalQuestionsDisplay = document.getElementById('total-questions-display');

        const finalScorePercentageDisplay = document.getElementById('final-score-percentage');
        const correctAnswersCountDisplay = document.getElementById('correct-answers-count');
        const totalQuestionsResultsDisplay = document.getElementById('total-questions-results');
        const timeTakenResultsDisplay = document.getElementById('time-taken-results');

        const performanceDetailsContainer = document.getElementById('performance-details-container');
        
        const formatScreen = document.getElementById('format-screen');
        const formatCards = document.querySelectorAll('.format-card-button');

        const typewriterOutput = document.getElementById('typewriter-output');


        // --- UPDATED: Screen Navigation System ---
        const allScreens = [
            { element: welcomeScreen, name: 'welcome', nav: null }, 
            { element: lobbyScreen, name: 'lobby', nav: lobbyNav }, 
            { element: formatScreen, name: 'format', nav: formatNav }, 
            { element: quizScreen, name: 'quiz', nav: quizNav }, 
            { element: resultsScreen, name: 'results', nav: resultsNav }, 
            { element: performanceScreen, name: 'performance', nav: performanceNav }
        ];
        // NEW: List of all nav content blocks
        const allNavContents = [lobbyNav, formatNav, quizNav, resultsNav, performanceNav];
        let currentPage = welcomeScreen;

        /**
         * Central navigation function with transitions and dynamic nav bar.
         * @param {HTMLElement} screenToShow The screen element to transition to.
         * @param {string} direction 'forward' (slide right) or 'backward' (slide left).
         */
        function navigateTo(screenToShow, direction = 'forward') {
            const oldPage = currentPage;
            const newPage = screenToShow;
            
            // Find the screen config object
            const newScreenConfig = allScreens.find(s => s.element === newPage);

            // 1. Handle Nav Bar Visibility
            if (newPage === welcomeScreen) {
                bottomNavBar.classList.add('hidden');
            } else {
                bottomNavBar.classList.remove('hidden');
            }
            
            // 2. Handle Nav Content Visibility
            allNavContents.forEach(nav => nav.classList.add('hidden'));
            if (newScreenConfig && newScreenConfig.nav) {
                newScreenConfig.nav.classList.remove('hidden');
            }

            // 3. Handle Screen Transitions
            if (direction === 'forward') {
                newPage.classList.remove('left', 'current');
                newPage.classList.add('right');
            } else {
                newPage.classList.remove('right', 'current');
                newPage.classList.add('left');
            }
            
            newPage.classList.remove('hidden'); // Make it visible for transition
            
            // Force reflow
            void newPage.offsetWidth; 

            if (direction === 'forward') {
                oldPage.classList.remove('current');
                oldPage.classList.add('left');
                newPage.classList.remove('right');
                newPage.classList.add('current');
            } else { // backward
                oldPage.classList.remove('current');
                oldPage.classList.add('right');
                newPage.classList.remove('left');
                newPage.classList.add('current');
            }

            // 4. Update tracker
            currentPage = newPage;
        }
        // --- End Screen Navigation System ---


        // Quiz Variables
        let allQuestionsForCategory = []; 
        let currentQuestions = []; 
        let currentQuestionIndex = 0;
        let score = 0;
        let timerInterval;
        let quizDurationSeconds; 
        let timeLeft; 
        let quizStartTime;
        let selectedQuizCategory = null; 
        let selectedOption = null; 
        let quizResultsDetails = [];
        let isUnlimitedMode = false;

        // --- Typewriter Loop Logic ---
        const TYPE_TEXT = "Challenge\nYourself\nToday!";
        let charIndex = 0;
        let isDeleting = false;
        let isPaused = false;
        let delay = 100; 

        function typeWriterEffect() {
            if (isPaused) {
                setTimeout(typeWriterEffect, 500);
                return;
            }
            const currentText = TYPE_TEXT;
            if (!isDeleting) {
                if (charIndex < currentText.length) {
                    typewriterOutput.textContent += currentText.charAt(charIndex);
                    charIndex++;
                    delay = currentText.charAt(charIndex - 1) === '\n' ? 500 : 100;
                } else {
                    isPaused = true;
                    setTimeout(() => {
                        isPaused = false;
                        isDeleting = true;
                    }, 2000); 
                }
            } else {
                if (charIndex > 0) {
                    typewriterOutput.textContent = currentText.substring(0, charIndex - 1);
                    charIndex--;
                    delay = 50; 
                } else {
                    isDeleting = false;
                    setTimeout(() => {
                        typeWriterEffect(); 
                    }, 500); 
                    return; 
                }
            }
            setTimeout(typeWriterEffect, delay);
        }
        // --- End Typewriter Loop Logic ---

        // Utility function to show custom message box
        function showMessageBox(title, message, callback) {
            const messageBox = document.getElementById('message-box');
            const messageTitle = document.getElementById('message-title');
            const messageContent = document.getElementById('message-content');
            const messageOkButton = document.getElementById('message-ok-button');

            messageTitle.textContent = title;
            messageContent.textContent = message;
            messageBox.classList.remove('hidden');
            messageOkButton.onclick = () => {
                messageBox.classList.add('hidden');
                if (callback) callback();
            };
        }

        // Function to shuffle an array
        function shuffleArray(array) {
            let newArray = [...array]; 
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // Function to handle quiz category selection
        function selectQuizCategory(categoryKey) {
            formatCards.forEach(card => {
                card.dataset.category = categoryKey;
            });
            
            selectedQuizCategory = categoryKey;
            navigateTo(formatScreen, 'forward');
        }

        // Function to handle quiz format selection
        async function selectQuizFormat(event) {
            const card = event.currentTarget;
            
            const categoryKey = card.dataset.category;
            if (!categoryKey) {
                showMessageBox("Error", "Quiz category was not selected. Please return to Lobby.", () => {
                    navigateTo(lobbyScreen, 'backward');
                });
                return;
            }
            
            selectedQuizCategory = categoryKey; 
            
            const numQuestions = card.dataset.questions;
            const timeMinutes = card.dataset.time;
            
            isUnlimitedMode = (numQuestions === 'unlimited' || timeMinutes === 'unlimited');
            
            showMessageBox("Loading Quiz", "Preparing your questions...", null);
            
            try {
                // MODIFIED: Call new JSON fetch function
                await fetchQuestionsFromJson();

                let questionsToLoad;
                if (isUnlimitedMode) {
                    questionsToLoad = allQuestionsForCategory.length;
                    quizDurationSeconds = null; 
                } else {
                    questionsToLoad = Math.min(parseInt(numQuestions, 10), allQuestionsForCategory.length);
                    quizDurationSeconds = parseInt(timeMinutes, 10) * 60;
                }

                if (allQuestionsForCategory.length === 0) {
                    throw new Error("No questions were found for this category.");
                }
                
                currentQuestions = shuffleArray(allQuestionsForCategory).slice(0, questionsToLoad);
                currentQuestionIndex = 0;
                score = 0;
                quizResultsDetails = [];
                
                document.getElementById('message-box').classList.add('hidden');
                startQuiz();

            } catch (error) {
                console.error("Error preparing quiz:", error);
                showMessageBox("Error", `Failed to start quiz: ${error.message}`);
            }
        }
        
        /**
         * Fetches questions from local JSON files in the /data directory.
         */
        async function fetchQuestionsFromJson() {
            if (!selectedQuizCategory) {
                throw new Error("No quiz category selected.");
            }

            const categoryFilename = quizCategories[selectedQuizCategory];
            if (!categoryFilename) {
                throw new Error(`Invalid quiz category key: ${selectedQuizCategory}`);
            }
            
            // Build path to the local JSON file
            // This assumes index.html and the 'data' folder are in the same root directory
            const jsonPath = `./data/${categoryFilename}.json`;
            
            console.log("Fetching from:", jsonPath);
            
            try {
                const response = await fetch(jsonPath);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - Ensure ${jsonPath} exists`);
                }
                
                // The JSON file MUST contain an array of question objects
                allQuestionsForCategory = await response.json();
                console.log(`Fetched ${allQuestionsForCategory.length} questions.`);

                if (!Array.isArray(allQuestionsForCategory)) {
                    throw new Error("Data file is not a valid JSON array.");
                }
                
            } catch (error) {
                console.error("Error fetching local JSON:", error);
                throw new Error("Could not load questions. Please check your internet connection or if the data file exists.");
            }
        }


        // Function to start the quiz
        function startQuiz() {
            navigateTo(quizScreen, 'forward');
            quizStartTime = new Date();

            if (isUnlimitedMode) {
                timeLeftDisplay.textContent = "Untimed";
                totalQuestionsDisplay.textContent = currentQuestions.length;
            } else {
                timeLeft = quizDurationSeconds;
                updateTimerDisplay();
                timerInterval = setInterval(updateTimer, 1000);
                totalQuestionsDisplay.textContent = currentQuestions.length;
            }
            
            loadQuestion();
        }

        // Function to load the current question
        function loadQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                endQuiz();
                return;
            }

            const currentQuestion = currentQuestions[currentQuestionIndex];
            questionText.textContent = currentQuestion.question;
            currentQuestionNumberDisplay.textContent = currentQuestionIndex + 1;
            
            selectedOption = null;
            submitAnswerButton.disabled = true;

            const shuffledOptionKeys = shuffleArray(Object.keys(currentQuestion.options));
            
            optionButtons.forEach((button, index) => {
                const originalKey = shuffledOptionKeys[index];
                const optionText = currentQuestion.options[originalKey];
                const displayLabel = ['A', 'B', 'C', 'D'][index]; 

                button.textContent = `${displayLabel}. ${optionText}`;
                button.dataset.option = originalKey; 

                button.classList.remove('selected', 'correct', 'incorrect');
                button.disabled = false;
            });
        }

        // Function to handle answer submission
        function submitAnswer() {
            if (!selectedOption) return;

            const currentQuestion = currentQuestions[currentQuestionIndex];
            const isCorrect = (selectedOption === currentQuestion.correctAnswer);

            quizResultsDetails.push({
                question: currentQuestion.question,
                selectedOption: currentQuestion.options[selectedOption],
                correctOption: currentQuestion.options[currentQuestion.correctAnswer],
                isCorrect: isCorrect
            });

            if (isCorrect) {
                score++;
            }
            
            optionButtons.forEach(button => {
                button.disabled = true; 
                const buttonOptionKey = button.dataset.option;
                
                if (buttonOptionKey === currentQuestion.correctAnswer) {
                    button.classList.add('correct');
                } else if (button.classList.contains('selected')) {
                    button.classList.add('incorrect');
                }
            });

            setTimeout(() => {
                currentQuestionIndex++;
                loadQuestion();
            }, 1500);
        }

        // Function to update the timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timeLeftDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Function to update the timer every second
        function updateTimer() {
            timeLeft--;
            if (timeLeft < 0) {
                endQuiz(true); 
            } else {
                updateTimerDisplay();
            }
        }

        // Function to end the quiz
        function endQuiz(timedOut = false) {
            clearInterval(timerInterval);
            
            const timeTaken = Math.floor((new Date() - quizStartTime) / 1000);
            const minutes = Math.floor(timeTaken / 60);
            const seconds = timeTaken % 60;
            
            let totalQuestionsAnswered = currentQuestions.length;
            if (timedOut) {
                totalQuestionsAnswered = currentQuestionIndex; 
            }

            let percentageScore = 0;
            if (totalQuestionsAnswered > 0) {
                percentageScore = ((score / totalQuestionsAnswered) * 100).toFixed(0);
            }

            finalScorePercentageDisplay.textContent = percentageScore;
            correctAnswersCountDisplay.textContent = score;
            totalQuestionsResultsDisplay.textContent = totalQuestionsAnswered;
            
            if (isUnlimitedMode) {
                 timeTakenResultsDisplay.textContent = `Time taken: ${minutes}m ${seconds}s`;
            } else if (timedOut) {
                timeTakenResultsDisplay.textContent = `Time ran out! You spent ${minutes}m ${seconds}s on the quiz.`;
            } else {
                timeTakenResultsDisplay.textContent = `and finished in ${minutes}m ${seconds}s.`;
            }

            navigateTo(resultsScreen, 'forward');
        }

        // Function to show performance breakdown
        function showPerformance() {
            navigateTo(performanceScreen, 'forward');
            performanceDetailsContainer.innerHTML = ''; 

            if (quizResultsDetails.length === 0) {
                performanceDetailsContainer.innerHTML = '<p class="text-center text-gray-600">No questions were answered in this quiz session.</p>';
                return;
            }

            quizResultsDetails.forEach((result, index) => {
                let feedbackHTML = '';
                if (result.isCorrect) {
                    feedbackHTML = `<p class="performance-answer correct-feedback">Your answer: ${result.selectedOption} (Correct)</p>`;
                } else {
                    feedbackHTML = `
                        <p class="performance-answer incorrect-feedback">Your answer: ${result.selectedOption} (Incorrect)</p>
                        <p class="performance-correct-answer">Correct answer: ${result.correctOption}</p>
                    `;
                }

                const itemHTML = `
                    <div class="performance-item">
                        <p class="performance-question">${index + 1}. ${result.question}</p>
                        ${feedbackHTML}
                    </div>
                `;
                performanceDetailsContainer.innerHTML += itemHTML;
            });
        }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            typeWriterEffect();
            
            // Unlock the buttons immediately since we don't need to wait for auth
            quizCategoryButtons.forEach(button => button.disabled = false);
            loadingMessage.classList.add('hidden');
            
            // Initial screen state setup
            allScreens.forEach(s => {
                if (s.element !== welcomeScreen) {
                    s.element.classList.add('right'); // All start off-screen right
                }
            });
            welcomeScreen.classList.add('current');
            currentPage = welcomeScreen;


            // --- Welcome Screen ---
            continueButton.addEventListener('click', () => {
                navigateTo(lobbyScreen, 'forward');
            });

            // --- Lobby Screen ---
            quizCategoryButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    const categoryKey = event.currentTarget.dataset.quizCategory;
                    selectQuizCategory(categoryKey);
                });
            });
            
            backToWelcomeFromLobby.addEventListener('click', () => {
                navigateTo(welcomeScreen, 'backward');
            });

            // --- Format Screen ---
            formatCards.forEach(card => {
                card.addEventListener('click', selectQuizFormat);
            });

            backToLobbyFromFormat.addEventListener('click', () => {
                navigateTo(lobbyScreen, 'backward');
            });

            // --- Quiz Screen ---
            optionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    optionButtons.forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    selectedOption = button.dataset.option;
                    submitAnswerButton.disabled = false;
                });
            });

            submitAnswerButton.addEventListener('click', submitAnswer);
            
            quitQuizButton.addEventListener('click', () => {
                showMessageBox("Quit", "Are you sure you want to end the quiz?", () => {
                    endQuiz(false); 
                });
            });

            // --- Results Screen ---
            returnToLobbyFromResultsButton.addEventListener('click', () => {
                navigateTo(lobbyScreen, 'backward');
            });
            
            seePerformanceButton.addEventListener('click', () => {
                showPerformance();
            });

            // --- Performance Screen ---
            returnToLbbyFromPerformanceButton.addEventListener('click', () => {
                navigateTo(lobbyScreen, 'backward');
            });
        });

    </script>
</body>
</html>
